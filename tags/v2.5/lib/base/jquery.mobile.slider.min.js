/* smartVISU, Martin Glei√ü, 2013, GPL <http://www.gnu.de> */
(function(a,v){a.widget("mobile.slider",a.mobile.widget,{widgetEventPrefix:"slide",options:{theme:null,trackTheme:null,disabled:!1,initSelector:"input[type='range'], :jqmData(type='range'), :jqmData(role='slider')",mini:!1,highlight:!1},_create:function(){var d=this.element,n=a.mobile.getInheritedTheme(d,"c"),l=this.options.theme||n,n=this.options.trackTheme||n,f=d[0].nodeName.toLowerCase();this.isToggleSwitch="select"===f;var j=d.parent().is(":jqmData(role='rangeslider')"),k=this.isToggleSwitch?
"ui-slider-switch":"",g=d.attr("id"),b=a("[for='"+g+"']"),r=b.attr("id")||g+"-label",b=b.attr("id",r),h=!this.isToggleSwitch?parseFloat(d.attr("min")):0,s=!this.isToggleSwitch?parseFloat(d.attr("max")):d.find("option").length-1,e=d.attr("orientation"),c=window.parseFloat(d.attr("step")||1),m=this.options.mini||d.jqmData("mini")?" ui-mini":"",t=document.createElement("a"),g=a(t),p=document.createElement("div"),q=a(p),u;if(this.options.highlight&&!this.isToggleSwitch){u=document.createElement("div");
if("semicircle"==e){u.className="ui-slider-bg";var w=document.createElement("div");w.className="ui-slider-track-semicircle "+a.mobile.activeBtnClass;u.appendChild(w)}else u.className="ui-slider-bg "+a.mobile.activeBtnClass+" ui-btn-corner-all";u=a(u).prependTo(q)}else u=!1;t.setAttribute("href","#");p.setAttribute("role","application");p.className=[(this.isToggleSwitch?"ui-slider":"ui-slider-track")+(e?"-"+e:" "),k," ui-btn-down-",n," ui-btn-corner-all",m].join("");t.className="ui-slider-handle"+
(e?"-"+e:"");p.appendChild(t);"semicircle"==e&&(k=document.createElement("div"),k.className="ui-slider-semicircle-box",e=document.createElement("div"),e.className="ui-slider-semicircle-cut",k.appendChild(e),e.appendChild(p),m=document.createElement("div"),m.className="ui-slider-semicircle-inner ui-body-"+n,e.appendChild(m),e=document.createElement("div"),e.className="ui-slider-semicircle-bottom "+(u?a.mobile.activeBtnClass:"")+" ui-btn-down-"+n,e.style.cssFloat="left",k.appendChild(e),e=document.createElement("div"),
e.className="ui-slider-semicircle-bottom ui-btn-down-"+n,e.style.cssFloat="right",k.appendChild(e),q=a(k));g.buttonMarkup({corners:!0,theme:l,shadow:!0}).attr({role:"slider","aria-valuemin":h,"aria-valuemax":s,"aria-valuenow":this._value(),"aria-valuetext":this._value(),title:this._value(),"aria-labelledby":r});a.extend(this,{slider:q,handle:g,type:f,step:c,max:s,min:h,valuebg:u,isRangeslider:j,dragging:!1,beforeStart:null,userModified:!1,mouseMoved:!1});if(this.isToggleSwitch){l=document.createElement("div");
l.className="ui-slider-inneroffset";f=0;for(r=p.childNodes.length;f<r;f++)l.appendChild(p.childNodes[f]);p.appendChild(l);g.addClass("ui-slider-handle-snapping");l=d.find("option");g=0;for(p=l.length;g<p;g++)f=!g?"b":"a",r=!g?" ui-btn-down-"+n:" "+a.mobile.activeBtnClass,document.createElement("div"),h=document.createElement("span"),h.className=["ui-slider-label ui-slider-label-",f,r," ui-btn-corner-all"].join(""),h.setAttribute("role","img"),h.appendChild(document.createTextNode(l[g].innerHTML)),
a(h).prependTo(q);this._labels=a(".ui-slider-label",q)}b.addClass("ui-slider");d.addClass(this.isToggleSwitch?"ui-slider-switch":"ui-slider-input");this._on(d,{change:"_controlChange",keyup:"_controlKeyup",blur:"_controlBlur",vmouseup:"_controlVMouseUp"});q.bind("vmousedown",a.proxy(this._sliderVMouseDown,this)).bind("vclick",!1);this._on(document,{vmousemove:"_preventDocumentDrag"});this._on(q.add(document),{vmouseup:"_sliderVMouseUp"});q.insertAfter(d);!this.isToggleSwitch&&!j&&(l=this.options.mini?
"<div class='ui-slider ui-mini'>":"<div class='ui-slider'>",d.add(q).wrapAll(l));this.isToggleSwitch&&this.handle.bind({focus:function(){q.addClass(a.mobile.focusClass)},blur:function(){q.removeClass(a.mobile.focusClass)}});this._on(this.handle,{vmousedown:"_handleVMouseDown",keydown:"_handleKeydown",keyup:"_handleKeyup"});this.handle.bind("vclick",!1);this._handleFormReset&&this._handleFormReset();this.refresh(v,v,!0)},_controlChange:function(a){if(!1===this._trigger("controlchange",a))return!1;
this.mouseMoved||this.refresh(this._value(),!0)},_controlKeyup:function(){this.refresh(this._value(),!0,!0)},_controlBlur:function(){this.refresh(this._value(),!0)},_controlVMouseUp:function(){this._checkedRefresh()},_handleVMouseDown:function(){this.handle.focus()},_handleKeydown:function(d){var n=this._value();if(!this.options.disabled){switch(d.keyCode){case a.mobile.keyCode.HOME:case a.mobile.keyCode.END:case a.mobile.keyCode.PAGE_UP:case a.mobile.keyCode.PAGE_DOWN:case a.mobile.keyCode.UP:case a.mobile.keyCode.RIGHT:case a.mobile.keyCode.DOWN:case a.mobile.keyCode.LEFT:d.preventDefault(),
this._keySliding||(this._keySliding=!0,this.handle.addClass("ui-state-active"))}switch(d.keyCode){case a.mobile.keyCode.HOME:this.refresh(this.min);break;case a.mobile.keyCode.END:this.refresh(this.max);break;case a.mobile.keyCode.PAGE_UP:case a.mobile.keyCode.UP:case a.mobile.keyCode.RIGHT:this.refresh(n+this.step);break;case a.mobile.keyCode.PAGE_DOWN:case a.mobile.keyCode.DOWN:case a.mobile.keyCode.LEFT:this.refresh(n-this.step)}}},_handleKeyup:function(){this._keySliding&&(this._keySliding=!1,
this.handle.removeClass("ui-state-active"))},_sliderVMouseDown:function(a){if(this.options.disabled||!1===this._trigger("beforestart",a))return!1;this.dragging=!0;this.mouseMoved=this.userModified=!1;this.isToggleSwitch&&(this.beforeStart=this.element[0].selectedIndex);this.refresh(a);this._trigger("start");return!1},_sliderVMouseUp:function(){if(this.dragging)return this.dragging=!1,this.isToggleSwitch&&(this.handle.addClass("ui-slider-handle-snapping"),this.mouseMoved?this.userModified?this.refresh(0===
this.beforeStart?1:0):this.refresh(this.beforeStart):this.refresh(0===this.beforeStart?1:0)),this.mouseMoved=!1,this._trigger("stop"),!1},_preventDocumentDrag:function(a){if(!1===this._trigger("drag",a))return!1;if(this.dragging&&!this.options.disabled)return this.mouseMoved=!0,this.isToggleSwitch&&this.handle.removeClass("ui-slider-handle-snapping"),this.refresh(a),this.userModified=this.beforeStart!==this.element[0].selectedIndex,!1},_checkedRefresh:function(){this.value!=this._value()&&this.refresh(this._value())},
_value:function(){return this.isToggleSwitch?this.element[0].selectedIndex:parseFloat(this.element.val())},_reset:function(){this.refresh(v,!1,!0)},refresh:function(d,n,l){var f=a.mobile.getInheritedTheme(this.element,"c"),j=this.options.theme||f,f=this.options.trackTheme||f,k=this.element.attr("orientation");this.slider[0].className="semicircle"==k?"ui-slider-semicircle-box":[this.isToggleSwitch?"ui-slider ui-slider-switch":"ui-slider-track"+(k?"-"+k:" ")," ui-btn-down-"+f," ui-btn-corner-all",this.options.mini?
" ui-mini":""].join("");(this.options.disabled||this.element.attr("disabled"))&&this.disable();this.value=this._value();this.options.highlight&&(!this.isToggleSwitch&&0===this.slider.find(".ui-slider-bg").length)&&(f=document.createElement("div"),f.className="ui-slider-bg "+a.mobile.activeBtnClass+" ui-btn-corner-all",this.valuebg=a(f).prependTo(this.slider));this.handle.buttonMarkup({corners:!0,theme:j,shadow:!0});var g,b,j=this.element,r=(f=!this.isToggleSwitch)?[]:j.find("option"),h=f?parseFloat(j.attr("min")):
0,s=f?parseFloat(j.attr("max")):r.length-1,e=f&&0<parseFloat(j.attr("step"))?parseFloat(j.attr("step")):1,k=j.attr("orientation");if("object"===typeof d){var c,m;b=d;c=this.slider.offset().left;m=this.slider.width();g=m/((s-h)/e);if(!this.dragging||b.pageX<c-8||b.pageX>c+m+8)return;"vertical"==k?b=Math.round(100*((b.pageY-this.slider.offset().top)/this.slider.height())):"bottomup"==k?b=100-Math.round(100*((b.pageY-this.slider.offset().top)/this.slider.height())):"semicircle"==k?(c=b.pageX-this.slider.offset().left-
this.slider.width()/2-2,b=-(b.pageY-this.slider.offset().top-this.slider.height()+8),b=Math.round(100*((180*(Math.atan2(c,b)/Math.PI)+90)/180)),0>b&&(b=0),100<b&&(b=100)):b=1<g?100*((b.pageX-c)/m):Math.round(100*((b.pageX-c)/m))}else null==d&&(d=f?parseFloat(j.val()||0):j[0].selectedIndex),b=100*((parseFloat(d)-h)/(s-h));if(!isNaN(b)){c=b/100*(s-h)+h;var t=(c-h)%e;c-=t;2*Math.abs(t)>=e&&(c+=0<t?e:-e);t=100/((s-h)/e);c=parseFloat(c.toFixed(5));"undefined"===typeof g&&(g=m/((s-h)/e));1<g&&f&&(b=(c-
h)*t*(1/e));0>b&&(b=0);100<b&&(b=100);c<h&&(c=h);c>s&&(c=s);"vertical"==k?(this.handle.css("top",b+"%"),this.valuebg&&this.valuebg.css("height",b+"%")):"bottomup"==k?(this.handle.css("top",100-b+"%"),this.valuebg&&this.valuebg.css("margin-top",(this.slider.height()*(100-b)/100).toFixed(0)+"px"),this.valuebg&&this.valuebg.css("height",b+"%")):"semicircle"==k?(g=(180*(b/100)-90)/180*Math.PI,this.handle.css("top",Math.round(-Math.cos(g)*(this.slider.width()/2-8)+((0==this.slider.height()?92:this.slider.height())-
4))+"px"),this.handle.css("left",Math.round(Math.sin(g)*(this.slider.width()/2-8)+(this.slider.width()/2+4))+"px"),m=(1.08*b-8).toFixed(0),this.valuebg&&this.valuebg.css("width",(1>m?1:m)+"%")):(this.handle.css("left",b+"%"),this.valuebg&&this.valuebg.css("width",b+"%"));this.handle[0].setAttribute("aria-valuenow",f?c:r.eq(c).attr("value"));this.handle[0].setAttribute("aria-valuetext",f?c:r.eq(c).getEncodedText());this.handle[0].setAttribute("title",f?c:r.eq(c).getEncodedText());if(this._labels){g=
100*(this.handle.width()/this.slider.width());var p=b&&g+(100-g)*b/100,q=100===b?0:Math.min(g+100-p,100);this._labels.each(function(){var b=a(this).is(".ui-slider-label-a");a(this).width((b?p:q)+"%")})}if(!l){l=!1;f?(l=j.val()!==c,j.val(c)):(l=j[0].selectedIndex!==c,j[0].selectedIndex=c);if(!1===this._trigger("beforechange",d))return!1;!n&&l&&j.trigger("change")}}},enable:function(){this.element.attr("disabled",!1);this.slider.removeClass("ui-disabled").attr("aria-disabled",!1);return this._setOption("disabled",
!1)},disable:function(){this.element.attr("disabled",!0);this.slider.addClass("ui-disabled").attr("aria-disabled",!0);return this._setOption("disabled",!0)}});a.widget("mobile.slider",a.mobile.slider,a.mobile.behaviors.formReset);a.mobile.document.bind("pagecreate create",function(d){a.mobile.slider.prototype.enhanceWithin(d.target,!0)})})(jQuery); 
