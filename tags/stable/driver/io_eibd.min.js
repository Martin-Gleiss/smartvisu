/* smartVISU, Martin Glei√ü, 2013, GPL <http://www.gnu.de> */
var io={adress:"",port:"",read:function(a){io.get(a)},write:function(a,b){io.put(a,b)},init:function(a,b){io.adress=a;io.port=b;io.stop()},run:function(a){widget.refresh();io.all(!0);a&&io.start()},timer:0,timer_run:!1,actualIndexNumber:-1,actualRequest:!1,allDataReadTimer:0,lastRequestStarted:0,reloadAllDataTime:1800,restartRequestTime:60,checkRequest:function(){var a=Math.floor($.now()/1E3);a-io.restartRequestTime>io.lastRequestStarted&&(io.actualRequest.abort(),io.all());a-io.reloadAllDataTime>
io.allDataReadTimer&&(io.actualRequest.abort(),io.all(!0));setTimeout("io.checkRequest()",1E3)},start:function(){!io.timer_run&&widget.listening()&&(io.timer_run=!0,setTimeout("io.checkRequest()",1E3))},stop:function(){clearTimeout(io.timer);io.timer_run=!1},convertData:function(a,b,d){var c=a;if("9.xxx"==b)if("from"==d)data=parseInt(a,16).toString(10),wert=data&2047,0!=(data&32768)&&(wert|=4294965248,wert*=-1),wert<<=(data&30720)>>11,0!=(data&32768)&&(wert*=-1),c=wert/100;else{a*=100;d=b=0;0>a&&
(b=32768,a=-a);for(;2047<a;)a>>=1,d++;0!=b&&(a=-a);b=b|a&2047|d<<11&30720;for(c=Number(b+8388608).toString(16);5>c.length;)c="0"+c}else"1.001"==b?"to"==d&&(c="8"+a):"5.001"==b&&("from"==d?c=a:"to"==d&&(c=Math.round(2.55*a)+32768,c=c.toString(16)));return c},get:function(a){$.ajax({url:"http://"+io.adress+":"+io.port+"/cgi-bin/r?"+getForUrl,type:"GET",dataType:"json",async:!0,cache:!1}).done(function(b){widget.update(a,b[a])})},put:function(a,b){var d=io.timer_run;io.stop();$.ajax({url:"http://"+io.adress+
":"+io.port+"/cgi-bin/w",data:{a:a.substring(0,a.length-6),v:io.convertData(b,a.slice(-5),"to"),ts:$.now()},type:"GET",dataType:"json",cache:!1}).done(function(){widget.update(a,b);d&&io.start()})},all:function(a){a&&(io.actualIndexNumber=-1,io.allDataReadTimer=Math.floor($.now()/1E3));io.lastRequestStarted=Math.floor($.now()/1E3);if(widget.listening()){a="";for(var b=0,d=widget.listeners(),c=0;c<d.length;c++)0<b&&(a+="&"),a=a+"a="+d[c].substring(0,d[c].length-6),b++;a=a+"&i="+io.actualIndexNumber;
io.actualRequest=$.ajax({url:"http://"+io.adress+":"+io.port+"/cgi-bin/r?"+a,type:"GET",dataType:"json",async:!0,cache:!1}).done(function(a){"object"==typeof a?($.each(a,function(a,b){"i"==a&&(io.actualIndexNumber=b);"d"==a&&$.each(b,function(a,b){for(var c=0;c<d.length;c++)if(oneItem=d[c],oneItem.substring(0,oneItem.length-6)==a){var e=oneItem.slice(-5);b=io.convertData(b,e,"from");widget.update(oneItem,b)}})}),io.all()):notify.error("Driver: eibd",a)})}}}; 
