/* smartVISU, Martin Glei√ü, 2013, GPL [http://www.gnu.de] */
var io={adress:"",port:"",read:function(a){},write:function(a,b){io.send({cmd:"item",id:a,val:b});widget.update(a,b)},trigger:function(a,b){},init:function(a,b){io.address=a;io.port=b;io.open()},run:function(a){1<io.socket.readyState?io.open():(widget.refresh(),io.monitor())},version:"0.1",socket:!1,open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.send({cmd:"proto",ver:io.version});io.monitor()};io.socket.onmessage=function(a){var b,c=JSON.parse(a.data);
switch(c.cmd){case "item":for(var d=0;d<c.items.length;d+=2)a=c.items[d],b=c.items[d+1],widget.update(a,b);break;case "dialog":notify.info(c.header,c.content);case "proto":a=c.ver,a!=io.version&&notify.info("Driver: DomotiGa","Protocol mismatch<br />Driver is at version v"+io.version+"<br />DomotiGa is at version v"+a)}};io.socket.onerror=function(a){notify.error("Driver: DomotiGa","Websocket error: "+a)};io.socket.onclose=function(){notify.error("Driver: DomotiGa","Could not connect to DomotiGa server!")}},
send:function(a){1==io.socket.readyState&&io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))))},monitor:function(){widget.listeners().length&&io.send({cmd:"monitor",items:widget.listeners()})},close:function(){io.socket.close();io.socket=null}}; 
