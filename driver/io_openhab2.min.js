/* smartVISU, Patrik Germann, 2020, GPL [http://www.gnu.de] */
var io={url:"",read:function(c){$.ajax({url:io.url+"items/"+c+"/state",type:"GET",async:!0,cache:!1}).done(function(b){widget.update(c,io.transval[b]?io.transval[b]:b)}).error(notify.json)},write:function(c,b){if(0==b||1==b){var a=[],d=$(event.currentTarget).attr("id");switch(io.itemType[c]){case "Switch":a[0]="OFF";a[1]="ON";break;case "Contact":a[0]="CLOSED";a[1]="OPEN";break;case "Dimmer":a[0]="OFF";a[1]="ON";if("plus"==d.slice(-4)||"minus"==d.slice(-5))a[0]="DECREASE",a[1]="INCREASE";break;case "Rollershutter":a[0]=
"UP";a[1]="DOWN";if("up"==d.slice(-2)||"down"==d.slice(-4))a[0]="UP",a[1]="DOWN";else if("start"==d.slice(-5)||"stop"==d.slice(-4))a[0]="STOP",a[1]="START";else if("plus"==d.slice(-4)||"minus"==d.slice(-5))a[0]="DECREASE",a[1]="INCREASE";break;case "Player":if(a[0]="PAUSE",a[1]="PLAY","stop"==d.slice(-4)||"play"==d.slice(-4))a[0]="PAUSE",a[1]="PLAY";else if("prev"==d.slice(-4)||"next"==d.slice(-4))a[0]="PREVIOUS",a[1]="NEXT";else if("rew"==d.slice(-3)||"ff"==d.slice(-2))a[0]="REWIND",a[1]="FASTFORWARD"}a[b]&&
(b=a[b])}$.ajax({url:io.url+"items/"+c,data:b.toString(),method:"POST",contentType:"text/plain",cache:!1}).error(notify.json)},trigger:function(c,b){},init:function(c,b){io.url="http://"+c+(b?":"+b:"")+"/rest/"},run:function(c){io.stop();if(widget.listeners().length)for(var b=widget.listeners(),a=0;a<widget.listeners().length;a++)$.ajax({url:io.url+"items/"+b[a],type:"GET",async:!0,cache:!1}).done(function(a){var b=a.name;io.itemType[b]=a.type;widget.update(b,io.transval[a.state]?io.transval[a.state]:
a.state)}).error(notify.json);io.plot.init();c&&io.start()},transval:{"null":"0",NULL:"0",OFF:"0",ON:"1",CLOSED:"0",OPEN:"1",PAUSE:"0",PLAY:"1",REWIND:"0",FASTFORWARD:"1"},itemType:[],eventListener:!1,start:function(){io.eventListener=new EventSource(io.url+"events?topics=smarthome/items/*/statechanged");io.eventListener.onmessage=function(c){var b=JSON.parse(c.data);"ItemStateChangedEvent"===b.type&&(c=b.topic.split("/")[2],widget.listeners().includes(c)&&(b=JSON.parse(b.payload).value,widget.update(c,
io.transval[b]?io.transval[b]:b)),io.plot.listeners[c]&&Date.now()-io.plot.items[io.plot.listeners[c]]>1E3*io.plot.timer&&io.plot.refresh(io.plot.listeners[c]))}},stop:function(){0!=io.eventListener.readyState&&1!=io.eventListener.readyState||io.eventListener.close()},plot:{items:[],listeners:[],timer:60,init:function(){io.plot.listeners=[];widget.plot().each(function(c){c=widget.explode($(this).attr("data-item"));for(var b=0;b<c.length;b++){var a=c[b],d=a.split(".");!io.plot.items[a]&&d instanceof
Array&&widget.checkseries(a)&&("now"==d[3]&&(io.plot.listeners[d[0]]=a),io.plot.refresh(a),io.plot.items[a]=!0)}})},refresh:function(c){var b=c.split("."),a=b[0],d=(new Date).duration(b[2]),e=b[3],g=new Date(Date.now()-d);a=io.url+"persistence/items/"+a+"?starttime="+g.toISOString();if("now"!=e){e=(new Date).duration(b[3]);var f=new Date(new Date-e);a+="&endtime="+f.toISOString()}$.ajax({url:a,type:"GET",dataType:"json",async:!1,cache:!1}).done(function(a){var b=[];0<a.data.length?($.each(a.data,
function(a,c){var d=io.transval[c.state]?io.transval[c.state]:c.state;isNaN(d)?d=0:Number(d)==d&&0!==d%1&&(d=parseFloat(d).toFixed(2));b.push([c.time,parseFloat(d)])}),b.sort(function(a,b){return a[0]-b[0]})):(b.push([Date.parse(g),0]),b.push([f?Date.parse(f):Date.now(),0]));io.plot.items[c]=Date.now();widget.update(c,b)}).error(notify.json)}}}; 
