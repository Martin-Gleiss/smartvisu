/* smartVISU, Martin Glei√ü, 2012 - 2015, GPL [http://www.gnu.de] */
var io={address:"",port:"",read:function(b){io.get(b)},write:function(b,a){io.put(b,a)},trigger:function(b,a){},init:function(b,a){io.address=b;io.port=a;io.stop()},run:function(b){widget.refresh();io.all();io.allPlots();b&&io.start()},plotItems:[],start:function(){var b=this;(new EventSource("http://"+io.address+":"+io.port+"/rest/events?topics=smarthome/items/*/state")).addEventListener("message",function(a){a=JSON.parse(a.data);if("ItemStateEvent"===a.type){var c=JSON.parse(a.payload),d=a.topic.split("/")[2],
e=io.getItemFromOHItem(d);e&&widget.update(e,io.convertFromOH(e,c.value));b.plotItems.forEach(function(b){var a=b.split(".");io.getOHItemFromItem(a[0])==d&&(a=[[(new Date).getTime(),parseFloat(io.convertFromOH(e,c.value))]],widget.update(b,a))})}})},stop:function(){},get:function(b){var a="http://"+io.address+":"+io.port+"/rest/items/"+io.getOHItemFromItem(b)+"/state";$.ajax({url:a,type:"GET",async:!0,cache:!1}).done(function(a){widget.update(b,a)}).error(notify.json)},put:function(b,a){var c=io.timer_run,
d="http://"+io.address+":"+io.port+"/rest/items/"+io.getOHItemFromItem(b);io.stop();$.ajax({url:d,data:io.convertToOH(b,a),method:"POST",contentType:"text/plain",cache:!1}).success(function(){widget.update(b,a);c&&io.start()}).error(notify.json)},convertToOH:function(b,a){var c=io.getTypeFromItem(b),d=a;switch(c){case "Switch":d=1==a?"ON":"OFF"}return d},convertFromOH:function(b,a){var c=io.getTypeFromItem(b),d=a;switch(c){case "Switch":d="ON"==a?1:0}return d},getTypeFromItem:function(b){b=b.split(":");
var a="Unknown";2==b.length&&(a=b[0]);return a},getOHItemFromItem:function(b){var a=b.split(":");2==a.length&&(b=a[1]);return b},getItemFromOHItem:function(b){for(var a=widget.listeners(),c=0;c<a.length;c++)if(b==io.getOHItemFromItem(a[c]))return a[c];return!1},all:function(){var b="";if(widget.listeners().length){for(var a=widget.listeners(),c=0;c<widget.listeners().length;c++)b+=a[c]+",";b=b.substr(0,b.length-1);$.ajax({url:"http://"+io.address+":"+io.port+"/rest/items",type:"GET",dataType:"json",
async:!0,cache:!1}).done(function(b){$.each(b,function(b,a){var c=io.getItemFromOHItem(a.name);c&&widget.update(c,io.convertFromOH(c,a.state))})}).error(notify.json)}},allPlots:function(){var b=this,a=[];widget.plot().each(function(c){c=widget.explode($(this).attr("data-item"));for(var d=0;d<c.length;d++){var e=c[d].split(".");if(!a[c[d]]&&!widget.get(c[d])&&e instanceof Array&&widget.checkseries(c[d])){var f=c[d],g=io.getOHItemFromItem(e[0]),e=(new Date).duration(e[2]),h=6E4*(new Date).getTimezoneOffset(),
e=(new Date(new Date-e-h)).toISOString().slice(0,-1);$.ajax({url:"http://"+io.address+":"+io.port+"/rest/persistence/"+g+"?servicename=rrd4j&starttime="+e,type:"GET",dataType:"json",async:!0,cache:!1}).done(function(b){var a=[];$.each(b.data,function(b,c){a.push([c.time,parseFloat(c.state)])});a.sort(function(a,b){return a[0]-b[0]});widget.update(f,a)}).error(notify.json);a[c[d]]=1;b.plotItems.push(c[d])}}})}}; 
