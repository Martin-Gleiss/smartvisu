/* smartVISU, Martin Glei√ü, 2012 - 2015, GPL [http://www.gnu.de] */
var io={adress:"",port:"",read:function(a){},write:function(a,b){io.send({cmd:"item",id:a,val:b});widget.update(a,b)},trigger:function(a,b){io.send({cmd:"logic",name:a,val:b})},init:function(a,b){io.address=a;io.port=b;io.open()},run:function(a){widget.refresh();io.monitor()},version:4,socket:false,open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.send({cmd:"proto",ver:io.version});io.monitor()};io.socket.onmessage=function(d){var c,f;var e=JSON.parse(d.data);console.log("[io.smarthome.py] receiving data: ",d.data);switch(e.cmd){case"item":for(var a=0;a<e.items.length;a++){c=e.items[a][0];f=e.items[a][1];if(f===false){f=0}if(f===true){f=1}widget.update(c,f)}break;case"series":if(io.version<=3){e.sid=e.sid+".100"}widget.update(e.sid.replace(/\|/g,"."),e.series);break;case"dialog":notify.info(e.header,e.content);break;case"log":if(e.init){widget.update(e.name,e.log)}else{var b=widget.get(e.name);for(var a=0;a<e.log.length;a++){b.unshift(e.log[a]);if(b.length>=50){b.pop()}}widget.update(e.name)}break;case"proto":io.version=parseInt(e.ver);if(io.version<3){notify.warning("Driver: smarthome.py","Protocol mismatch<br />SmartHome.py is: v"+io.version+"<br /><br /> Update the system!")}break}};io.socket.onerror=function(a){notify.error("Driver: smarthome.py","Could not connect to smarthome.py server!<br /> Websocket error "+a.data+".")};io.socket.onclose=function(){notify.debug("Driver: smarthome.py","Connection closed to smarthome.py server!")}},send:function(a){if(io.socket.readyState==1){io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))));console.log("[io.smarthome.py] sending data: ",JSON.stringify(a))}},monitor:function(){if(widget.listeners().length){io.send({cmd:"monitor",items:widget.listeners()})}var a=Array();widget.plot().each(function(b){var c=widget.explode($(this).attr("data-item"));for(var d=0;d<c.length;d++){var f=c[d].split(".");if(!a[c[d]]&&!widget.get(c[d])&&(f instanceof Array)&&widget.checkseries(c[d])){var e=c[d].substr(0,c[d].length-4-f[f.length-4].length-f[f.length-3].length-f[f.length-2].length-f[f.length-1].length);if(io.version<=3){io.send({cmd:"series",item:e,series:f[f.length-4],start:f[f.length-3],end:f[f.length-2]})}else{io.send({cmd:"series",item:e,series:f[f.length-4],start:f[f.length-3],end:f[f.length-2],count:f[f.length-1]})}a[c[d]]=1}}});widget.log().each(function(b){io.send({cmd:"log",name:$(this).attr("data-item"),max:$(this).attr("data-count")})})},close:function(){console.log("[io.smarthome.py] close connection");if(io.socket.readyState>0){io.socket.close()}io.socket=null}};