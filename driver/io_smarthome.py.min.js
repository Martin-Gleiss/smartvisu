/* smartVISU, Martin Glei√ü, 2012 - 2015, GPL [http://www.gnu.de] */
function get_browser(){var a=navigator.userAgent,b,d=a.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(d[1]))return b=/\brv[ :]+(\d+)/g.exec(a)||[],{name:"IE",version:b[1]||""};if("Chrome"===d[1]&&(b=a.match(/\bOPR\/(\d+)/),null!=b))return{name:"Opera",version:b[1]};d=d[2]?[d[1],d[2]]:[navigator.appName,navigator.appVersion,"-?"];null!=(b=a.match(/version\/(\d+)/i))&&d.splice(1,1,b[1]);return{name:d[0],version:d[1]}}
function get_visuinfo(){var a=new XMLHttpRequest;a.open("get","driver/io_smarthome_get_visuinfo.php",!1);a.send();visuinfo=JSON.parse(a.responseText);return{name:visuinfo[0],version:visuinfo[1]}}
var io={adress:"",port:"",read:function(a){},write:function(a,b){io.send({cmd:"item",id:a,val:b});widget.update(a,b)},trigger:function(a,b){io.send({cmd:"logic",name:a,val:b})},init:function(a,b){io.address=a;io.port=b;io.open()},run:function(a){widget.refresh();io.monitor()},version:4,socket:!1,open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.send({cmd:"proto",ver:io.version});var a=get_visuinfo(),b=get_browser();io.send({cmd:"identity",sw:a.name,
ver:a.version,browser:b.name,bver:b.version});io.monitor()};io.socket.onmessage=function(a){var b,d;a=JSON.parse(a.data);switch(a.cmd){case "item":for(var c=0;c<a.items.length;c++)b=a.items[c][0],d=a.items[c][1],!1===d&&(d=0),!0===d&&(d=1),widget.update(b,d);break;case "series":3>=io.version&&(a.sid+=".100");widget.update(a.sid.replace(/\|/g,"."),a.series);break;case "dialog":notify.info(a.header,a.content);break;case "log":if(a.init)widget.update(a.name,a.log);else{b=widget.get(a.name);for(c=0;c<
a.log.length;c++)b.unshift(a.log[c]),50<=b.length&&b.pop();widget.update(a.name)}break;case "proto":io.version=parseInt(a.ver),3>io.version&&notify.warning("Driver: smarthome.py","Protocol mismatch<br />SmartHome.py is: v"+io.version+"<br /><br /> Update the system!")}};io.socket.onerror=function(a){notify.error("Driver: smarthome.py","Could not connect to smarthome.py server!<br /> Websocket error "+a.data+".")};io.socket.onclose=function(){notify.debug("Driver: smarthome.py","Connection closed to smarthome.py server!")}},
send:function(a){1==io.socket.readyState&&io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))))},monitor:function(){widget.listeners().length&&io.send({cmd:"monitor",items:widget.listeners()});var a=[];widget.plot().each(function(b){b=widget.explode($(this).attr("data-item"));for(var d=0;d<b.length;d++){var c=b[d].split(".");if(!a[b[d]]&&!widget.get(b[d])&&c instanceof Array&&widget.checkseries(b[d])){var e=b[d].substr(0,b[d].length-4-c[c.length-4].length-c[c.length-3].length-c[c.length-
2].length-c[c.length-1].length);3>=io.version?io.send({cmd:"series",item:e,series:c[c.length-4],start:c[c.length-3],end:c[c.length-2]}):io.send({cmd:"series",item:e,series:c[c.length-4],start:c[c.length-3],end:c[c.length-2],count:c[c.length-1]});a[b[d]]=1}}});widget.log().each(function(a){io.send({cmd:"log",name:$(this).attr("data-item"),max:$(this).attr("data-count")})})},close:function(){0<io.socket.readyState&&io.socket.close();io.socket=null}}; 
