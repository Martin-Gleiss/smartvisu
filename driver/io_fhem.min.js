/* smartVISU, Martin Glei√ü, 2012 - 2015, GPL [http://www.gnu.de] */
var io={logLevel:1,alertExceptions:!1,offline:!1,measureGADs:!1,gadsToMeasure:10,gadFilter:"",addonDriverFile:"",driverVersion:"1.11",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,b){if(!io.offline){var c=!1;io.gadFilter&&(c=(new RegExp(io.gadFilter)).test(a));c?io.addon&&io.addon.write(a,b):(io.log(2,"write (gad="+a+" val="+b+")"),io.send({cmd:"item",id:a,val:b}))}io.updateWidget(a,b)},trigger:function(a,b){io.addon&&io.addon.trigger(a,b)},init:function(a,b){io.log(0,
"init [V"+io.driverVersion+"] (address="+a+" port="+b+")");io.address=a;io.port=b;io.alertExceptions&&(window.onerror=function(a,b,e){alert("Error: "+a+"\nurl: "+b+"\nline: "+e);return!1});"offline"===a&&(io.offline=!0);io.offline?io.log(0,"DRIVER IS IN OFFLINE MODE"):(io.open(),io.addonDriverFile&&$.getScript("driver/"+io.addonDriverFile).done(function(a,b){io.addon=new addonDriver;io.addon.init(io);io.addon.run()}).fail(function(a,b,e){io.addon=null}))},run:function(a){io.offline?(io.log(1,"run (OFFLINE)"),
io.monitor(),io.simulateData(),io.timer&&clearInterval(io.timer),io.timer=setInterval(function(){io.simulateData()},5E3)):(io.log(1,"run (readyState="+io.socket.readyState+")"),io.resetLoadTime(),io.addon&&io.addon.run(),1<io.socket.readyState?io.open():io.monitor())},protocolVersion:"0.1",socket:null,rcTimer:null,addon:null,log:function(a,b){},startReconnectTimer:function(){io.rcTimer||(io.log(1,"Reconnect timer started"),io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired");notify.add("ConnectionLost",
"connection","Driver: fhem","Connection to the fhem server lost!");notify.display();io.socket||io.open()},6E4))},stopReconnectTimer:function(){io.rcTimer&&(clearInterval(io.rcTimer),io.rcTimer=null,io.log(1,"Reconnect timer stopped"))},callUpdateHandler:function(a,b){var c=$(a).attr("data-widget"),d=$(a).attr("data-item"),e=io.action[c];try{e?e.handler.call(a,"update",b):$(a).trigger("update",b)}catch(f){io.log(0,"Widget '"+c+"' - "+d+": "+b+" Error: "+f)}},updateWidget:function(a,b){io.receivedGADs++;
var c="";io.logLoadTime("GAD #"+io.receivedGADs);widget.buffer[a]instanceof Array||void 0===b||(widget.buffer[a]=$.isNumeric(b)?1*b:b);$('[data-item*="'+a+'"]').each(function(d){c=$(this).attr("data-widget");d=widget.explode($(this).attr("data-item"));for(var e=$(this).attr("data-series"),f=0;f<d.length;f++)if(d[f]==a)if(e)io.callUpdateHandler(this,{gad:a,data:b});else{var g=widget.get(d);if(widget.check(g)&&(io.callUpdateHandler(this,g),0===c.lastIndexOf("icon.",0))){var h=io.action["icon."];try{h?
h.handler.call(this,"update",g):$(this).trigger("update",g)}catch(k){io.log(0,"Widget '"+c+"' - "+a+": "+g+" Error: "+k)}}}});io.logLoadTime("OK ("+c+")");io.showLoadTime()},updateChart:function(a,b,c,d){seriesData={gad:b,data:c,updatemode:d};io.callUpdateHandler(a,seriesData);io.log(2,"Chart updated: "+b+" size: "+c.length)},updatePlot:function(a,b,c,d){d=widget.explode($(a).attr("data-item"));for(var e=0;e<d.length;e++)d[e]=io.splitPlotGAD(d[e]).gad;widget.buffer[b]=c;"plot."==$(a).attr("data-widget").substr(0,
5)&&$("#"+a.id).highcharts()?$(a).trigger("point",[c]):(b=widget.get(d),widget.check(b)&&io.callUpdateHandler(a,b))},handleReceivedData:function(a){var b=0;a=JSON.parse(a);switch(a.cmd){case "reloadPage":location.reload(!0);break;case "item":for(b=0;b<a.items.length;b+=2)io.updateWidget(a.items[b],a.items[b+1]);break;case "series":for(b=0;b<a.items.length;b++){var c=a.items[b].gad,d=a.items[b].plotdata,e=a.items[b].updatemode;$('[data-item*="'+c+'"]').each(function(){for(var a=widget.explode($(this).attr("data-item")),
b=0;b<a.length;b++)io.isPlot(this,a[b])&&(a[b]=io.splitPlotGAD(a[b]).gad),a[b]===c&&(io.isPlot(this,a[b])?io.updatePlot(this,c,d,e):io.updateChart(this,c,d,e))})}break;case "dialog":notify.info(a.header,a.content);break;case "proto":b=a.ver,b!=io.protocolVersion&&notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.protocolVersion+"<br />fhem is at version v"+b)}},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.log(2,
"socket.onopen");io.stopReconnectTimer();io.send({cmd:"proto",ver:io.protocolVersion});io.monitor();notify.exists()&&notify.remove()};io.socket.onmessage=function(a){io.log(2,"socket.onmessage: data= "+a.data);io.handleReceivedData(a.data)};io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)};io.socket.onclose=function(){io.log(1,"socket.onclose");io.close();io.startReconnectTimer()}},send:function(a){io.offline?io.log(2,"OFFLINE send() data: "+JSON.stringify(a)):1==io.socket.readyState&&
(io.socket.send(unescape(encodeURIComponent(JSON.stringify(a)))),io.log(2,"send() data: "+JSON.stringify(a)))},isSeries:function(a,b){var c=!1,d=$(a).attr("data-series");if(d)for(var d=d.split(","),e=0;e<d.length;e++)if(d[e].trim()===b){c=!0;break}return c},isPlot:function(a,b){var c=$(a).attr("data-widget");return"plot.period"===c||"plot.rtr"===c},isLog:function(a,b){return"status.log"===$(a).attr("data-widget")},isValue:function(a,b){return!io.isSeries(a,b)&&!io.isPlot(a,b)&&!io.isLog(a,b)},splitGADs:function(){io.ownGADs=
[];io.fhemGADs=[];var a=[],b=[];io.allGADs.forEach(function(a){for(var c=widget.explode($(a).attr("data-item")),d=0;d<c.length;d++)io.isValue(a,c[d])&&(b[c[d]]="")});for(var c in b)a.push(c),io.offline&&io.offlineGADs.push(c);if(io.gadFilter){c=new RegExp(io.gadFilter);for(var d=0;d<a.length;d++){var e=a[d];c.test(e)?io.ownGADs.push(e):io.fhemGADs.push(e)}}else io.fhemGADs=a},splitPlotGAD:function(a){a=a.split(".");for(var b=0,c="";b<a.length-3;)c+=a[b]+(b==a.length-4?"":"."),b++;return{gad:c,mode:a[a.length-
3],start:a[a.length-2],end:a[a.length-1]}},splitSeries:function(){io.ownSeries=[];io.fhemSeries=[];io.allGADs.forEach(function(a){for(var b=$(a).attr("data-item").split(","),c=0;c<b.length;c++){var d=!1,e=b[c].trim(),f="",g="",h="",k="",m="",n="complete";if(io.isSeries(a,e))d=$(a).attr("data-modes"),f=d.split(","),f=1<f.length?f[c].trim():d,g=$(a).attr("data-tmin"),h=$(a).attr("data-tmax"),k=$(a).attr("data-interval"),m=$(a).attr("data-zoom"),d=!0;else if(io.isPlot(a,e)){var l=io.splitPlotGAD(e);
0<=$.inArray(l.mode,"avg min max sum diff rate on".split(" "))&&(e=l.gad,f=l.mode,g=l.start,h=l.end,k="OnChange",m=$(a).attr("data-zoom"),n="additional",d=!0)}d&&(e={gad:e,mode:f,start:g,end:"0"===h?"now":h,interval:k,minzoom:m,updatemode:n},io.offline&&io.offlineSeries.push(e),io.gadFilter?(new RegExp(io.gadFilter)).test(e.gad)?io.ownSeries.push(e):io.fhemSeries.push(e):io.fhemSeries.push(e))}})},splitLogs:function(){io.ownLogs=[];io.fhemLogs=[];io.allGADs.forEach(function(a){for(var b=$(a).attr("data-item").split(","),
c=0;c<b.length;c++)if(io.isLog(a,b[c].trim())){var d={gad:b[c].trim(),size:$(a).attr("data-count"),interval:$(a).attr("data-interval")};io.offline&&io.offlineLogs.push(d);io.gadFilter?(new RegExp(io.gadFilter)).test(d.gad)?io.ownLogs.push(d):io.fhemLogs.push(d):io.fhemLogs.push(d)}})},getAllGADs:function(){io.action={};io.allGADs=[];for(var a=($._data($(document)[0],"events")||{}).update,b=0;b<a.delegateCount;b++)/.*?data-widget?.="(.+?)".*/.exec(a[b].selector),io.action[RegExp.$1]={handler:a[b].handler};
$.mobile.activePage&&$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(a,b){io.allGADs.push(this)})},allGADs:[],fhemGADs:[],ownGADs:[],fhemSeries:[],ownSeries:[],fhemLogs:[],ownLogs:[],monitor:function(){if(io.offline||1==io.socket.readyState)io.logLoadTime("Monitor"),io.getAllGADs(),io.splitGADs(),io.splitSeries(),io.splitLogs(),io.logLoadTime("Monitor calculated"),io.log(1,"monitor (GADs:"+io.fhemGADs.length+", Series:"+io.fhemSeries.length+")"),io.fhemGADs.length&&io.send({cmd:"monitor",
items:io.fhemGADs}),io.fhemSeries.length&&io.send({cmd:"series",items:io.fhemSeries}),io.fhemLogs.length&&io.send({cmd:"log",items:io.fhemLogs}),io.addon&&io.addon.monitor(io.ownGADs,io.ownSeries,io.ownLogs),io.logLoadTime("Monitor done")},close:function(){null!=io.socket&&(io.socket.close(),io.socket=null,io.log(1,"socket closed"))},loadTimeLog:"Load-Times\n",timeStamp:0,receivedGADs:0,resetLoadTime:function(){io.measureGADs&&(io.receivedGADs=0,io.loadTimeLog="Load-Times\n",io.logLoadTime("Start"))},
logLoadTime:function(a){if(io.measureGADs){var b=new Date,c=0==io.timeStamp?0:b.getTime()-io.timeStamp;io.loadTimeLog+=b.toLocaleTimeString()+"."+("000"+b.getMilliseconds()).slice(-3)+" ("+c+" ms): "+a+"\n";io.timeStamp=b.getTime()}},showLoadTime:function(){io.measureGADs&&io.receivedGADs==io.gadsToMeasure&&io.loadTimeLog&&(io.logLoadTime(io.receivedGADs+" GADs"),alert(io.loadTimeLog))},timer:null,offlineGADs:[],offlineSeries:[],offlineLogs:[],simulateData:function(){for(b=0;b<io.offlineGADs.length;b++){var a=
[];a.push(io.offlineGADs[b]);a.push((100*Math.random()).toFixed(1));io.handleReceivedData('{"cmd":"item", "items": '+JSON.stringify(a)+"}")}(new Date).getTime();for(var b=0;b<io.offlineSeries.length;b++){for(var c=$('[data-item*="'+io.offlineSeries[b].gad+'"]')[0],a=(a=$(c).attr("data-tmin"))?a:"2d",d=$(c).attr("data-tmax"),d=d?d:"now",e=$(c).attr("data-ymin"),e=e?1*e:0,f=$(c).attr("data-ymax"),f=f?1*f:255,a=(new Date).getTime()-(new Date).duration(a),d=(new Date).getTime()-(new Date).duration(d),
c=Math.round((d-a)/100),g=e+(f-e)/2,e=(f-e)/20,f=[],h=0;a<=d&&1E4>++h;)g+=2*Math.random()*e-e,f.push([a,1*g.toFixed(2)]),a+=c;a='{"cmd":"series", "items": [{"gad": "'+io.offlineSeries[b].gad+'", "updatemode": "complete", "plotdata": '+JSON.stringify(f)+" }]}";io.handleReceivedData(a)}}}; 
