var io={logLevel:1,alertExceptions:!1,offline:!1,measureGADs:!1,gadsToMeasure:10,gadFilter:"",addonDriverFile:"",driverVersion:"1.11",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,b){if(io.offline);else{var c=!1;if(io.gadFilter){var d=new RegExp(io.gadFilter);c=d.test(a)}c?io.addon&&io.addon.write(a,b):(io.log(2,"write (gad="+a+" val="+b+")"),io.send({cmd:"item",id:a,val:b}))}io.updateWidget(a,b)},trigger:function(a,b){io.addon&&io.addon.trigger(a,b)},init:function(a,b){io.log(0,"init [V"+io.driverVersion+"] (address="+a+" port="+b+")"),io.address=a,io.port=b,io.alertExceptions&&(window.onerror=function(a,b,c){return alert("Error: "+a+"\nurl: "+b+"\nline: "+c),!1}),"offline"===a&&(io.offline=!0),io.offline?io.log(0,"DRIVER IS IN OFFLINE MODE"):(io.open(),io.addonDriverFile&&$.getScript("driver/"+io.addonDriverFile).done(function(a,b){io.addon=new addonDriver,io.addon.init(io),io.addon.run()}).fail(function(a,b,c){io.addon=null}))},run:function(a){io.offline?(io.log(1,"run (OFFLINE)"),io.monitor(),io.simulateData(),io.timer&&clearInterval(io.timer),io.timer=setInterval(function(){io.simulateData()},5e3)):(io.log(1,"run (readyState="+io.socket.readyState+")"),io.resetLoadTime(),io.addon&&io.addon.run(),io.socket.readyState>1?io.open():io.monitor())},protocolVersion:"0.1",socket:null,rcTimer:null,addon:null,log:function(a,b){io.logLevel>=a&&console.log("[io.fhem]: "+b)},startReconnectTimer:function(){io.rcTimer||(io.log(1,"Reconnect timer started"),io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired"),notify.add("ConnectionLost","connection","Driver: fhem","Connection to the fhem server lost!"),notify.display(),io.socket||io.open()},6e4))},stopReconnectTimer:function(){io.rcTimer&&(clearInterval(io.rcTimer),io.rcTimer=null,io.log(1,"Reconnect timer stopped"))},callUpdateHandler:function(a,b){var c=$(a).attr("data-widget"),d=$(a).attr("data-item"),e=io.action[c];try{e?e.handler.call(a,"update",b):$(a).trigger("update",b)}catch(a){io.log(0,"Widget '"+c+"' - "+d+": "+b+" Error: "+a)}},updateWidget:function(a,b){io.receivedGADs++;var c="";io.logLoadTime("GAD #"+io.receivedGADs),widget.buffer[a]instanceof Array||void 0===b||(widget.buffer[a]=$.isNumeric(b)?1*b:b),$('[data-item*="'+a+'"]').each(function(d){c=$(this).attr("data-widget");for(var e=widget.explode($(this).attr("data-item")),f=$(this).attr("data-series"),g=0;g<e.length;g++)if(e[g]==a)if(f){var h={gad:a,data:b};io.callUpdateHandler(this,h)}else{var i=widget.get(e);if(widget.check(i)&&(io.callUpdateHandler(this,i),0===c.lastIndexOf("icon.",0))){var j=io.action["icon."];try{j?j.handler.call(this,"update",i):$(this).trigger("update",i)}catch(b){io.log(0,"Widget '"+c+"' - "+a+": "+i+" Error: "+b)}}}}),io.logLoadTime("OK ("+c+")"),io.showLoadTime()},updateChart:function(a,b,c,d){seriesData={gad:b,data:c,updatemode:d},io.callUpdateHandler(a,seriesData),io.log(2,"Chart updated: "+b+" size: "+c.length)},updatePlot:function(a,b,c,d){for(var e=widget.explode($(a).attr("data-item")),f=0;f<e.length;f++)e[f]=io.splitPlotGAD(e[f]).gad;if(widget.buffer[b]=c,"plot."==$(a).attr("data-widget").substr(0,5)&&$("#"+a.id).highcharts())$(a).trigger("point",[c]);else{var g=widget.get(e);widget.check(g)&&io.callUpdateHandler(a,g)}},handleReceivedData:function(a){var b=0,c=JSON.parse(a);switch(c.cmd){case"reloadPage":location.reload(!0);break;case"item":for(b=0;b<c.items.length;b+=2)io.updateWidget(c.items[b],c.items[b+1]);break;case"series":for(b=0;b<c.items.length;b++){var d=c.items[b].gad,e=c.items[b].plotdata,f=c.items[b].updatemode;$('[data-item*="'+d+'"]').each(function(){for(var a=widget.explode($(this).attr("data-item")),b=0;b<a.length;b++)io.isPlot(this,a[b])&&(a[b]=io.splitPlotGAD(a[b]).gad),a[b]===d&&(io.isPlot(this,a[b])?io.updatePlot(this,d,e,f):io.updateChart(this,d,e,f))})}break;case"dialog":notify.info(c.header,c.content);break;case"proto":var g=c.ver;g!=io.protocolVersion&&notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.protocolVersion+"<br />fhem is at version v"+g);break;case"log":}},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/"),io.socket.onopen=function(){io.log(2,"socket.onopen"),io.stopReconnectTimer(),io.send({cmd:"proto",ver:io.protocolVersion}),io.monitor(),notify.exists()&&notify.remove()},io.socket.onmessage=function(a){io.log(2,"socket.onmessage: data= "+a.data),io.handleReceivedData(a.data)},io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)},io.socket.onclose=function(){io.log(1,"socket.onclose"),io.close(),io.startReconnectTimer()}},send:function(a){io.offline?io.log(2,"OFFLINE send() data: "+JSON.stringify(a)):1==io.socket.readyState&&(io.socket.send(unescape(encodeURIComponent(JSON.stringify(a)))),io.log(2,"send() data: "+JSON.stringify(a)))},isSeries:function(a,b){var c=!1,d=$(a).attr("data-series");if(d)for(var e=d.split(","),f=0;f<e.length;f++)if(e[f].trim()===b){c=!0;break}return c},isPlot:function(a,b){var c=$(a).attr("data-widget");return"plot.period"===c||"plot.rtr"===c},isLog:function(a,b){var c=$(a).attr("data-widget");return"status.log"===c},isValue:function(a,b){return!io.isSeries(a,b)&&!io.isPlot(a,b)&&!io.isLog(a,b)},splitGADs:function(){io.ownGADs=[],io.fhemGADs=[];var a=Array(),b=Array();io.allGADs.forEach(function(a){for(var c=widget.explode($(a).attr("data-item")),d=0;d<c.length;d++)io.isValue(a,c[d])&&(b[c[d]]="")});for(var c in b)a.push(c),io.offline&&io.offlineGADs.push(c);if(io.gadFilter)for(var d=new RegExp(io.gadFilter),e=0;e<a.length;e++){var f=a[e],g=d.test(f);g?io.ownGADs.push(f):io.fhemGADs.push(f)}else io.fhemGADs=a},splitPlotGAD:function(a){for(var b=a.split("."),c=0,d="";c<b.length-3;)d+=b[c]+(c==b.length-4?"":"."),c++;return{gad:d,mode:b[b.length-3],start:b[b.length-2],end:b[b.length-1]}},splitSeries:function(){io.ownSeries=[],io.fhemSeries=[],io.allGADs.forEach(function(a){for(var b=$(a).attr("data-item").split(","),c=0;c<b.length;c++){var d=!1,e=b[c].trim(),f="",g="",h="",i="",j="",k="complete";if(io.isSeries(a,e)){var l=$(a).attr("data-modes"),m=l.split(",");f=m.length>1?m[c].trim():l,g=$(a).attr("data-tmin"),h=$(a).attr("data-tmax"),i=$(a).attr("data-interval"),j=$(a).attr("data-zoom"),d=!0}else if(io.isPlot(a,e)){var n=io.splitPlotGAD(e);$.inArray(n.mode,Array("avg","min","max","sum","diff","rate","on"))>=0&&(e=n.gad,f=n.mode,g=n.start,h=n.end,i="OnChange",j=$(a).attr("data-zoom"),k="additional",d=!0)}if(d){var o={gad:e,mode:f,start:g,end:"0"===h?"now":h,interval:i,minzoom:j,updatemode:k};if(io.offline&&io.offlineSeries.push(o),io.gadFilter){var p=new RegExp(io.gadFilter);p.test(o.gad)?io.ownSeries.push(o):io.fhemSeries.push(o)}else io.fhemSeries.push(o)}}})},splitLogs:function(){io.ownLogs=[],io.fhemLogs=[],io.allGADs.forEach(function(a){for(var b=$(a).attr("data-item").split(","),c=0;c<b.length;c++)if(io.isLog(a,b[c].trim())){var d={gad:b[c].trim(),size:$(a).attr("data-count"),interval:$(a).attr("data-interval")};if(io.offline&&io.offlineLogs.push(d),io.gadFilter){var e=new RegExp(io.gadFilter);e.test(d.gad)?io.ownLogs.push(d):io.fhemLogs.push(d)}else io.fhemLogs.push(d)}})},getAllGADs:function(){io.action={},io.allGADs=[];for(var a=($._data($(document)[0],"events")||{}).update,b=0;b<a.delegateCount;b++){var c=a[b].selector,d=/.*?data-widget?.="(.+?)".*/;d.exec(c);var e=RegExp.$1,f=a[b].handler;io.action[e]={handler:f}}$.mobile.activePage&&$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(a,b){io.allGADs.push(this)})},allGADs:[],fhemGADs:[],ownGADs:[],fhemSeries:[],ownSeries:[],fhemLogs:[],ownLogs:[],monitor:function(){(io.offline||1==io.socket.readyState)&&(io.logLoadTime("Monitor"),io.getAllGADs(),io.splitGADs(),io.splitSeries(),io.splitLogs(),io.logLoadTime("Monitor calculated"),io.log(1,"monitor (GADs:"+io.fhemGADs.length+", Series:"+io.fhemSeries.length+")"),io.fhemGADs.length&&io.send({cmd:"monitor",items:io.fhemGADs}),io.fhemSeries.length&&io.send({cmd:"series",items:io.fhemSeries}),io.fhemLogs.length&&io.send({cmd:"log",items:io.fhemLogs}),io.addon&&io.addon.monitor(io.ownGADs,io.ownSeries,io.ownLogs),io.logLoadTime("Monitor done"))},close:function(){null!=io.socket&&(io.socket.close(),io.socket=null,io.log(1,"socket closed"))},loadTimeLog:"Load-Times\n",timeStamp:0,receivedGADs:0,resetLoadTime:function(){io.measureGADs&&(io.receivedGADs=0,io.loadTimeLog="Load-Times\n",io.logLoadTime("Start"))},logLoadTime:function(a){if(io.measureGADs){var b=new Date,c=0==io.timeStamp?0:b.getTime()-io.timeStamp;io.loadTimeLog+=b.toLocaleTimeString()+"."+("000"+b.getMilliseconds()).slice(-3)+" ("+c+" ms): "+a+"\n",io.timeStamp=b.getTime()}},showLoadTime:function(){io.measureGADs&&io.receivedGADs==io.gadsToMeasure&&io.loadTimeLog&&(io.logLoadTime(io.receivedGADs+" GADs"),alert(io.loadTimeLog))},timer:null,offlineGADs:[],offlineSeries:[],offlineLogs:[],simulateData:function(){for(c=0;c<io.offlineGADs.length;c++){var a=[];a.push(io.offlineGADs[c]),a.push((100*Math.random()).toFixed(1)),io.handleReceivedData('{"cmd":"item", "items": '+JSON.stringify(a)+"}")}for(var c=((new Date).getTime(),0);c<io.offlineSeries.length;c++){var d=$('[data-item*="'+io.offlineSeries[c].gad+'"]')[0],e=$(d).attr("data-tmin");e=e?e:"2d";var f=$(d).attr("data-tmax");f=f?f:"now";var g=100,h=$(d).attr("data-ymin");h=h?1*h:0;var i=$(d).attr("data-ymax");i=i?1*i:255;for(var j=(new Date).getTime()-(new Date).duration(e),k=(new Date).getTime()-(new Date).duration(f),l=Math.round((k-j)/g),m=h+(i-h)/2,n=(i-h)/20,o=[],p=0;j<=k&&++p<1e4;)m+=Math.random()*(2*n)-n,o.push([j,1*m.toFixed(2)]),j+=l;var q='{"cmd":"series", "items": [{"gad": "'+io.offlineSeries[c].gad+'", "updatemode": "complete", "plotdata": '+JSON.stringify(o)+" }]}";io.handleReceivedData(q)}}};
