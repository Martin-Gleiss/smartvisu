/* smartVISU, Martin GleiÃŸ, 2012 - 2015, GPL [http://www.gnu.de] */
var io={adress:"",port:"",read:function(a){io.get(a)},write:function(a,b){io.put(a,b)},trigger:function(a,b){},init:function(a,b){io.adress=a;io.port=b;io.stop()},run:function(a){widget.refresh();io.all(!0);a&&io.start()},timer:0,timer_run:!1,actualIndexNumber:-1,actualRequest:!1,allDataReadTimer:0,lastRequestStarted:0,reloadAllDataTime:1800,restartRequestTime:60,checkRequest:function(){var a=Math.floor($.now()/1E3);a-io.restartRequestTime>io.lastRequestStarted&&(io.actualRequest.abort(),io.all());
a-io.reloadAllDataTime>io.allDataReadTimer&&(io.actualRequest.abort(),io.all(!0));setTimeout("io.checkRequest()",1E3)},start:function(){!io.timer_run&&widget.listeners().length&&(io.timer_run=!0,setTimeout("io.checkRequest()",1E3))},stop:function(){clearTimeout(io.timer);io.timer_run=!1},convertData:function(a,b,d){var c=a;if("9.xxx"==b)if("from"==d)data=parseInt(a,16).toString(10),wert=data&2047,0!=(data&32768)&&(wert|=4294965248,wert*=-1),wert<<=(data&30720)>>11,0!=(data&32768)&&(wert*=-1),c=wert/
100;else{a*=100;d=b=0;0>a&&(b=32768,a=-a);for(;2047<a;)a>>=1,d++;0!=b&&(a=-a);for(c=Number((b|a&2047|d<<11&30720)+8388608).toString(16);5>c.length;)c="0"+c}else"1.001"==b?"to"==d&&(c="8"+a):c=parseInt(a,16);return c},get:function(a){$.ajax({url:"http://"+io.adress+":"+io.port+"/cgi-bin/r?"+getForUrl,type:"GET",dataType:"json",async:!0,cache:!1}).done(function(b){widget.update(a,b[a])}).error(notify.error("Driver: eibd","Error reading item!"))},put:function(a,b){var d=io.timer_run;io.stop();$.ajax({url:"http://"+
io.adress+":"+io.port+"/cgi-bin/w",data:{a:io.getItemFromItem(a),v:io.convertData(b,io.getDataTypeFromItem(a),"to"),ts:$.now()},type:"GET",dataType:"json",cache:!1}).done(function(c){widget.update(a,b);d&&io.start()}).error(notify.error("Driver: eibd","Error writing item!"))},all:function(a){a&&(io.actualIndexNumber=-1,io.allDataReadTimer=Math.floor($.now()/1E3));io.lastRequestStarted=Math.floor($.now()/1E3);if(widget.listeners().length){a="";for(var b=0,d=widget.listeners(),c=0;c<d.length;c++)0<
b&&(a+="&"),a=a+"a="+io.getItemFromItem(d[c]),b++;a=a+"&i="+io.actualIndexNumber;io.actualRequest=$.ajax({url:"http://"+io.adress+":"+io.port+"/cgi-bin/r?"+a,type:"GET",dataType:"json",async:!0,cache:!1}).done(function(a){"object"==typeof a?($.each(a,function(a,b){"i"==a&&(io.actualIndexNumber=b);"d"==a&&$.each(b,function(a,b){for(var c=0;c<d.length;c++)if(oneItem=d[c],io.getItemFromItem(oneItem)==a){var e=io.getDataTypeFromItem(oneItem);b=io.convertData(b,e,"from");widget.update(oneItem,b)}})}),
io.all()):notify.error("Driver: eibd",a)})}},getDataTypeFromItem:function(a){itemArray=a.split("/");return dataType=4==itemArray.length?itemArray[3]:"1.001"},getItemFromItem:function(a){itemArray=a.split("/");return requestItem=itemArray[0]+"/"+itemArray[1]+"/"+itemArray[2]}}; 
