/**
* -----------------------------------------------------------------------------
* @package     smartVISU
* @author      Martin Gleiß, Alexander Schwithal, Stefan Widmer, Wolfram v. Hülsen
* @copyright   2012 - 2020
* @license     GPL [http://www.gnu.de]
* -----------------------------------------------------------------------------
*/


{% extends "system.html" %}

{% import "forms.html" as forms %}

{% block content %}

	/** related JavaScript part located in lib/base/base.js */
	<script src="lib/base/config.js"></script>
	<script type="text/javascript">
		var metas = [];
	</script>

	<h1>{{ lang('configuration_page', 'configuration', 'label') }}</h1>

	{%
	set sources = {
		'global': lang('configuration_page', 'globaltab', 'label'),
		'pages': lang('configuration_page', 'pagestab', 'label') ~ " '" ~ config_pages ~ "'",
		'cookie': lang('configuration_page', 'cookietab', 'label'),
	}
	%}

	<div data-role="tabs" id="config_source">
		<div data-role="navbar">
			<ul>
		    {% for source, title in sources %}
					<li data-source="{{ source }}"><a href="#config_tab_{{ source }}" data-ajax="false"{{ (configtarget is not defined and loop.first) or (configtarget is defined and configtarget == source) ? ' class="ui-btn-active"'|raw }}>{{ title }}</a></li>
		    {% endfor %}
			</ul>
		</div>

	{% for source, title in sources %}
		{% set values = read_config(source) %}
		{% set defaults = read_config( source=='global' ? 'default' : 'global') %}
		<div id="config_tab_{{ source }}">
			<h2>{{ lang('configuration_page', source ~ 'tab', 'hint') }}</h2>

			<form id="{{ source }}_configform" class="configform">
				<fieldset>
					{% if (configpages is defined) and (configpages != values.pages) %}
						{% set values = values|merge({'pages':configpages}) %}
						{% set values = values|merge({'index':defaults.index}) %}
					{% endif %}
					<div class="block">
						<div class="set-3" data-role="collapsible-set" data-content-theme="a" data-mini="true">
							<div class="ui-bar-c ui-corner-top ui-collapsible-caption">
								<h3 class="ui-collapsible-heading">{{ lang('configuration_page', 'userinterface', 'label') }}</h3>
							</div>
							<div data-role="collapsible" data-collapsed="false" data-theme="c" data-content-theme="a">
								<h3>{{ lang('configuration_page', 'interface', 'label') }}</h3>
								<div style="min-height:245px">
									{{ forms.config_input('title', values, defaults, source) }}
									{{ forms.config_select('pages', values, defaults, source, dir('pages', '^(?!base|apps)(.+?)') ) }}
									/**{{ forms.config_select('index', values, defaults, source, dir('pages/'~values.pages, '^(.*?)\.html$') ) }}*/
									{{ forms.config_row('design', values, defaults, source,
										[
										forms.config_select('design', values, defaults, source, dir('designs', '(.+?).css'), 'true')
										,forms.config_hidden('design_icon0', values, defaults, source)
										,forms.config_hidden('design_icon1', values, defaults, source)
										] 
									) }}
									{{ forms.config_select('lang', values, defaults, source, dir('lang', '^(.*?)\.ini$') ) }}
									{{ forms.config_cache('cache', values, defaults, source) }}
								</div>
							</div>
							<div data-role="collapsible" data-collapsed="true" data-theme="c" data-content-theme="a">
								<h3>{{ lang('configuration_page', 'behaviour', 'label') }}</h3>
								{{ forms.config_flip('animation', values, defaults, source) }}
								{{ forms.config_input('backtohometime', values, defaults, source, 'wide') }}
								{{ forms.config_select('timesource', values, defaults, source, [{"name": "client", "label": "Client"}, {"name": "server", "label": "Server"}]) }}
								{{ forms.config_select('timezone', values, defaults, source, timezones()) }}
							</div>
						</div>
					</div>
					{% if (configdriver is defined) and (configdriver != values.driver) %}
						{% for key,val in values %}
							{% if 'driver_' in key %}
								/** saves old value in 'olddriver_key' (actually unnecessary, for further use) and set value to 'unset' */
								{% set values = values|merge({(values.driver~'_'~key):val}) %}
								{% set values = values|merge({(''~key):'unset'}) %}
							{% endif %}
						{% endfor %}
						/** set defaults from new driver */
						{% set values = values|merge({'driver':configdriver}) %}
					{% endif %}
					{% if isfile('driver/'~values.driver~'/config.js') %}
						<script src="{{ 'driver/'~values.driver~'/config.js' }}"></script>
					{% endif %}
					<div class="block">
						<div class="set-3" data-role="collapsible-set" data-mini="true">
							<div class="ui-bar-c ui-corner-top ui-collapsible-caption">
								<h3 class="ui-collapsible-heading">{{ lang('configuration_page', 'backend', 'label') }}</h3>
							</div>
							<div data-role="collapsible" data-collapsed="false" data-theme="c" data-content-theme="a">
								<h3>{{ lang('configuration_page', 'ioconnection', 'label') }}</h3>
								<div style="min-height:180px">
									{{ forms.config_select('driver', values, defaults, source, dir('driver', '^io_(.+?).js') ) }}

									{% set drivermeta = configmeta('driver/io_'~values['driver']~'.js') %}
									{% if drivermeta != [] %}
										{% for name,field in drivermeta.config %}
											{% if prevgroup is defined and prevgroup != field.group %}
								</div>
							</div>
							<div data-role="collapsible" data-collapsed="true" data-theme="c" data-content-theme="a" >
								<h3>{{ lang('configuration_page', field.group, 'title') != '' ? lang('configuration_page', field.group, 'title') : field.group }}</h3>
								<div style="min-height:184px;">
											{% endif %}
											
											{% if (values['driver_'~name] is not defined) or (values['driver_'~name] == 'unset') %}
												{% set values = values|merge({('driver_'~name):field.default}) %}
											{% endif %}
											{% if field.type == 'input' %}
												{{ forms.config_input('driver_'~name, values, defaults, source, 'wide') }}
											{% elseif field.type == 'flip' %}
												{{ forms.config_flip('driver_'~name, values, defaults, source) }}
											{% elseif field.type == 'password' %}
												{{ forms.config_input('driver_'~name, values, defaults, source, 'password') }}
											{% elseif field.type == 'hidden' %}
												{{ forms.config_hidden('driver_'~name, values, defaults, source) }}
											{% elseif field.type == 'select' %}
												{{ forms.config_select('driver_'~name, values, defaults, source, field.default) }}
											{% endif %}
											
											{% set prevgroup = field.group %}
										{% endfor %}
									{% endif %}
								</div>
							</div>
							<div data-role="collapsible" data-collapsed="true" data-theme="c" data-content-theme="a" >
								<h3>{{ lang('configuration_page', 'proxyserver', 'label') }}</h3><br />
								{{ forms.config_flip('proxy', values, defaults, source) }}
								{{ forms.config_input('proxy_url', values, defaults, source, 'wide') }}
								{{ forms.config_input('proxy_user', values, defaults, source) }}
								{{ forms.config_input('proxy_password', values, defaults, source, 'password') }}
							</div>
						</div>
					</div>

					<div class="block">
						<div class="set-3" data-role="collapsible-set" data-content-theme="a" data-mini="true">
							<div class="ui-bar-c ui-corner-top ui-collapsible-caption">
								<h3 class="ui-collapsible-heading">{{ lang('configuration_page', 'dataservices', 'label') }}</h3>
							</div>
							<div data-role="collapsible" data-collapsed="false" data-theme="c" data-content-theme="a">
								<h3>{{ lang('configuration_page', 'weather', 'label') }}</h3>
								{{ forms.config_select('weather_service', values, defaults, source, dir('lib/weather/service', '(.+?).php') ) }}
								{{ forms.config_input('weather_location', values, defaults, source) }}
								{{ forms.config_input('weather_key', values, defaults, source) }}
								{{ forms.config_input('weather_postal', values, defaults, source) }}
							</div>
							<div data-role="collapsible" data-theme="c" data-content-theme="a">
								<h3>{{ lang('configuration_page', 'phone', 'label') }}</h3>
								{{ forms.config_select('phone_service', values, defaults, source, dir('lib/phone/service', '(.+?).php') ) }}
								{{ forms.config_input('phone_server', values, defaults, source, 'wide') }}
								{{ forms.config_input('phone_port', values, defaults, source, 'wide') }}
								{{ forms.config_input('phone_user', values, defaults, source) }}
								{{ forms.config_input('phone_pass', values, defaults, source, 'password') }}
							</div>
							<div data-role="collapsible" data-theme="c" data-content-theme="a">
								<h3>{{ lang('configuration_page', 'calendar', 'label') }}</h3>
								{{ forms.config_select('calendar_service', values, defaults, source, dir('lib/calendar/service', '(.+?).php') ) }}
								{{ forms.config_input('calendar_url', values, defaults, source) }}
								{{ forms.config_input('calendar_username', values, defaults, source) }}
								{{ forms.config_input('calendar_password', values, defaults, source, 'password') }}
								{{ forms.config_input('calendar_name', values, defaults, source) }}
								{{ forms.config_input('calendar_color', values, defaults, source) }}
								{{ forms.config_row('calendar_google_refresh_token', values, defaults, source,
									[
										'<a href="#calendar_googleauth_popup" data-rel="popup" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-icon-left ui-icon-action ui-micro' ~ (not values['calendar_google_refresh_token'] is defined ? ' ui-btn-active') ~ ' " data-icon="delete" data-inline="true" id="' ~ source ~ '_calendar_googleauth_button">' ~ lang('configuration_page', 'calendar_google_refresh_token', 'button') ~ '</a>'
										,forms.config_hidden('calendar_google_client_id', values, defaults, source)
										,forms.config_hidden('calendar_google_client_secret', values, defaults, source)
										,forms.config_hidden('calendar_google_refresh_token', values, defaults, source)
									]
								) }}
							</div>
						</div>
					</div>

					<div class="block">
						<div class="set-2" data-role="collapsible-set" data-content-theme="a" data-mini="true">
							<div class="ui-bar-c ui-corner-top ui-collapsible-caption">
								<h3 class="ui-collapsible-heading">{{ lang('configuration_page', 'options', 'label') }}</h3>
							</div>
/**							<div data-role="collapsible" data-collapsed="false" data-theme="c" data-content-theme="a" >
								<h3>{{ lang('configuration_page', 'widgetassistant', 'label') }}</h3>
								{{ forms.config_flip('widgetassi', values, defaults, source) }}
							</div>
*/							<div data-role="collapsible" data-collapsed="false" data-theme="c" data-content-theme="a" >
								<h3>{{ lang('configuration_page', 'updatecheck', 'label') }}</h3>
								{{ forms.config_flip('updatecheck', values, defaults, source) }}
							</div>
						</div>
					</div>

				</fieldset>

				<button type="submit" id="{{ source}}_save" data-theme="b" data-icon="grid" name="submit" value="1">{{ lang('configuration_page', 'save', 'label') }}</button>
			</form>
		</div>
	{% endfor %}
	</div>
	
	<div id="calendar_googleauth_popup" data-role="popup" data-overlay-theme="a">
		<div data-role="header" data-theme="c">
			<h1>{{ lang('configuration_page','calendar_googleauth', 'instruct_title') }}</h1>
		</div>
		<div role="main" class="ui-content">
			<form id="googleauthform">
				<ol>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_1')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_2')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_3')|raw }}
						<ul>
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_3a')|raw }}</li>
						</ul>
					</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_4')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_5')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_6')|raw }}
						<ol type="a">
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_6a')|raw }}</li>
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_6b')|raw }}</li>
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_6c')|raw }}</li>
						</ol>
					</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_7')|raw }}
						<ol type="a">
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_7a')|raw }}</li>
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_7b')|raw }}<br>
								<input type="text" type="hidden" name="script_origin" id="script_origin" readonly="readonly" onclick="this.select();"> <!-- filled in by JavaScript -->
							</li>
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_7c')|raw }}</li>
						</ol>
					</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_8')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_9')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_10')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_11')|raw }}
						<input type="file" id="google_json_file">
						 {{ lang('configuration_page','calendar_googleauth', 'instruct_11_hint')|raw }}
					</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_12')|raw }}</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_13')|raw }}
						<ul>
							<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_13a')|raw }}</li>
						</ul>
					</li>
					<li>{{ lang('configuration_page','calendar_googleauth', 'instruct_14')|raw }}</li>
				</ol>

				<hr>

				<div class="ui-field-contain" style="display: none">
					<label for="google_json_text">google_json_text</label>
					<textarea id="google_json_text"></textarea>
				</div>
				<div class="ui-field-contain">
					<label for="client_id">{{ lang('configuration_page', 'calendar_googleauth', 'client_id') }}:</label>
					<input type="text" name="client_id" id="client_id" value="">
				</div>
				<div class="ui-field-contain">
					<label for="client_secret"> {{ lang('configuration_page', 'calendar_googleauth', 'client_secret') }}:</label>
					<input type="text" id="client_secret" value=""> <!-- no name attribute, so it is not sent by submitting form -->
				</div>

				<div id="calendar_googleauth_submitcontainer" style="position: relative; overflow: hidden;">
					<button type="submit" data-theme="b" data-icon="check" name="submit" value="1">{{ lang('configuration_page', 'calendar_google_refresh_token', 'button') }}</button>
				</div>

			</form>
		</div>
	</div>

{% endblock %}
