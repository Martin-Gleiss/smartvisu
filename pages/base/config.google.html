<!DOCTYPE html>
<html>
<head>
<!--
This file is needed to work around google's restriction of private IP numbers as origins.
It is called by adding '.nip.io' to the hostname, which actually is an IP number (see http://nip.io/)
-->
<script src="//accounts.google.com/gsi/client"></script>
<style type="text/css">
	html, body {
		width: 100%;
		height: 100%;
		background-color: transparent;
		overflow: hidden;
		cursor: pointer;
	}
</style>
<script type="text/javascript">
	var params;

	window.addEventListener("message", function(e) {
		if(e.data.subject != 'googleauth')
			return;

		if(e.origin != location.origin.replace('.nip.io', ''))
			throw "Invalid origin";

		params = { clientId: e.data.clientId, origin: e.origin, window: e.source };
	}, false);

	function grantOfflineAccess() {
		try {
			var codeClient = google.accounts.oauth2.initCodeClient({
				client_id: params.clientId,
				scope: 'https://www.googleapis.com/auth/calendar.readonly',
				ux_mode: 'popup',
				callback: function(resp) {
					if (resp.error)
						// possible errors: idpiframe_initialization_failed (with subtype), popup_closed_by_user, popup_blocked_by_browser, access_denied, immediate_failed
						params.window.postMessage({ subject: 'googleauth', error: { code: resp.error, message: resp.error + ": " + resp.details ? + resp.details : "no details" } }, params.origin);
					else
						params.window.postMessage({ subject: 'googleauth', code: resp.code }, params.origin);
				}
			});
			codeClient.requestCode();
		}
		catch(ex) {
			params.window.postMessage({ subject: 'googleauth', error: { code: 'Exception', message: ex.toString() } }, params.origin);
			throw ex;
		}
	}
</script>
</head>
<body onclick="grantOfflineAccess()">
</body>
</html>