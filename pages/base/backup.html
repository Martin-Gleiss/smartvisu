/**
* -----------------------------------------------------------------------------
* @package     smartVISU
* @author      Martin Glei√ü
* @copyright   2012 - 2025
* @license     GPL [http://www.gnu.de]
* -----------------------------------------------------------------------------
*/


{% extends "system.html" %}

{% block content %}
<style>
    .backupFileInput::file-selector-button {
        border: 2px solid #cccccc;
        border-radius: inherit;
    }
</style>

<h1>{{ lang('backup', 'title') }}</h1>
<div class="block">
    <div class="set-1" data-role="collapsible-set" data-theme="c" data-content-theme="a" data-mini="true">
        <div data-role="collapsible" data-collapsed="false" style="position: relative;">
            <h3>{{ lang('backup', 'export', 'head') }}</h3>
            <p>
                {{ lang('backup', 'export', 'hint') }}
            </p>
            <br/>
            <div class="exportSizeWarning"></div>
            <form id="exportBackupFileForm" style="position: absolute; bottom: 0; right: 5px; left: 5px;">
                <button type="submit" data-theme="b">{{ lang('backup', 'export', 'button') }}</button>
            </form>
        </div>
    </div>
</div>

<div class="block">
    <div class="set-1" data-role="collapsible-set" data-theme="c" data-content-theme="a" data-mini="true">
        <div data-role="collapsible" data-collapsed="false" style="position: relative;">
            <h3>{{ lang('backup', 'import', 'head') }}</h3>
            <p>
                {{ lang('backup', 'import', 'hint') }}
            </p>
            <br/>
            <form id="restoreBackupFileForm" style="position: absolute; bottom: 0; right: 5px; left: 5px;">
                <input type="file" accept="application/zip" id="restoreBackupFile" style="padding-top: 0.2em;"
                       class="backupFileInput" required/>
                <br/>
                <button type="submit" data-theme="b">{{ lang('backup', 'import', 'button') }}</button>
            </form>
        </div>
    </div>
</div>

<script>
    async function uploadBackup(formData) {
        var response = {}
        try {
            response = await fetch("lib/backup.php", {
                method: "POST",
                body: formData,
            });
            const result = await response.clone().json();
            if (response.ok)
                notify.message("info", result.title, result.text);
            else
                notify.message("error", result.title, result.text);
            document.querySelector("#restoreBackupFile").value = null;
        } catch (error) {
            // if json error message is preceded by a system message: retrieve original error message from php script
            var fullText = await response.text();
            var myError = fullText.split(/({.*})/);
            if (myError.length > 1){
                var skriptMessage = JSON.parse(myError[1]);
                notify.message("error", skriptMessage.title, skriptMessage.text)		
            } else
                notify.message("error", "Error", error.toString()  );
        }
		$('[type="submit"]').removeAttr('disabled');
    }

    function restoreFunc() {
        let formData = new FormData();
        formData.append("restoreBackup", "Restore");
        formData.append("restoreBackupFile", document.querySelector("#restoreBackupFile").files[0]);
        uploadBackup(formData);
    }

    async function downloadBackup(formData) {
        try {
            const response = await fetch("lib/backup.php", {
                method: "POST",
                body: formData,
            });
            const result = await response.blob();
            if (response.ok) {
                const url = URL.createObjectURL(result);

                const headerparts = response.headers.get('content-disposition').split(';');
                const filename = headerparts[1].split('=')[1];

                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();

                a.remove();
                URL.revokeObjectURL(url);

                if (response.headers.get('filesize') > response.headers.get('maxpostsize') || response.headers.get('filesize') > response.headers.get('maxuploadsize'))
                    $('.exportSizeWarning').html(sv_lang.backup.export.size + '<br>post_max_size = ' + response.headers.get('maxpostsize') + '<br>upload_max_filesize = ' + response.headers.get('maxuploadsize') )
                    .css('border', 'solid red').css('padding', '4px 0 4px 0');

                notify.message("info", "Backup", sv_lang.backup.export.successful);
            } else {
                const resultJson = await result.text();
                const resultParsed = JSON.parse(resultJson);
                notify.message("error", resultParsed.title, resultParsed.text);
            }
        } catch (error) {
            notify.message("error", "Error", error.toString());
        }
        $('[type="submit"]').removeAttr('disabled');
    }

    function exportFunc() {
        let formData = new FormData();
        formData.append("exportBackup", "Backup");
        downloadBackup(formData);
    }

    $('#restoreBackupFileForm').on('submit', function(event) {
        event.preventDefault();
        $('[type="submit"]').attr('disabled','');
        restoreFunc();
    });

    $('#exportBackupFileForm').on('submit', function(event) {
        event.preventDefault();
        $('[type="submit"]').attr('disabled','');
        $('.exportSizeWarning').html('').css('border', '').css('padding', '');;
        exportFunc();
    });

</script>

{% endblock %}