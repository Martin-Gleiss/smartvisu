/**
 * -----------------------------------------------------------------------------
 * @package     smartVISU
 * @author      Martin Gleiß
 * @copyright   2012
 * @license     GPL <http://www.gnu.de>
 * ----------------------------------------------------------------------------- 
 */ 
                

/**
 * Widget to glue to html-elements together.
 * If the 'from' ist changed the 'to' will be reloaded after a delay. 
 * 
 * @param        id from the element who ist changing 
 * @param        id from the element that should be changed
 */
{% macro glue(id_from, id_to) %}
    /** Events */
    <script type="text/javascript">
        /*
        $('#{{ page }}').on('pageshow',function(event, ui){ 
            $('#{{ page }}-{{ id_from|e }}').bind('click', function(){
                window.setTimeout(function(){ $('#{{ page }}-{{ id_to|e }}').trigger('reload'); }, {{ config_delay }});
            });
        });
        */
        console.log('warning: basic.glue is deprecated!');
    </script>  
{% endmacro %}


/**
 * display a value
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        a unit
 * @param        the parent html-tag for the value                   
 */
{% macro value(id, gad, unit, tag) %}
    /** Design */
    <{{ tag|default('span') }} id="{{ page }}-{{ id }}"></{{ tag|default('span') }}>

    /** Events */
    <script type="text/javascript">
        knx.add({
            gad: '{{ gad }}', 
            update: function(response){ $('#{{ page }}-{{ id }}').html(response + ' {{ unit }}'); }
        });
    </script>    
{% endmacro %}


/**
 * Displays a value as float
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        a unit
 * @param        the parent html-tag for the value     
 */
{% macro float(id, gad, unit, tag) %}
    /** Design */
    <{{ tag|default('span') }} id="{{ page }}-{{ id }}">0.0</{{ tag|default('span') }}>

    /** Events */
    <script type="text/javascript">
        knx.add({
            gad: '{{ gad }}', 
            update: function(response){
                $('#{{ page }}-{{ id }}').html( ((Math.round(response * 10) / 10).toFixed(1)) + ' {{ unit }}');
            }
        });
    </script>   
{% endmacro %}


/**
 * Displays a checkbox
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        text printed on the checkbox
 */
{% macro checkbox(id, gad, txt) %}
    /** Design */
    <label><input type="checkbox" id="{{ page }}-{{ id }}" />{{ txt }}</label>
    
    /** Events */
    <script type="text/javascript">
        knx.add({ 
            gad: '{{ gad }}',
            update: function(response){
                $('#{{ page }}-{{ id }}').attr('checked', (response > 0 ? true : false)).checkboxradio('refresh');    
            }
        });
        
        $('#{{ page }}-{{ id }}').on('change', function(){ 
            knx.write('{{ gad }}', ($('#{{ page }}-{{ id }}:checked').val() == 'on' ? 1 : 0));
        });
    </script>    
{% endmacro %}


/**
 * Displays a flip-switch
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        text for the 'on' state
 * @param        text for the 'off' state
 */
 {% macro flip(id, gad, txt_on, txt_off) %}
    /** Design */
    <select id="{{ page }}-{{ id }}" data-role="slider">
	   <option value="off">{{ txt_off|default('Off') }}</option>
	   <option value="on">{{ txt_on|default('On') }}</option>
    </select> 

    /** Events */
    <script type="text/javascript">
        knx.add({ 
            gad: '{{ gad }}',
            update: function(response){ $('#{{ page }}-{{ id }}').val(response > 0 ? 'on' : 'off').slider('refresh'); }
        }); 
    
        $('#{{ page }}').on('pageshow', function(event, ui){ 
             var fval = $('#{{ page }}-{{ id }}').unbind('change').bind('change', function(){  
                if(fval != $(this).val())
                {
                    fval = $(this).val();
                    knx.write('{{ gad }}', (fval == 'on' ? 1 : 0));
                }
            }).val();
        });
    </script>    
{% endmacro %}


/**
 * Displays a slider-control
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        the minimum value if the slider ist moved to total left (optional, default 0)
 * @param        the maximum value if the slider ist moved to total right (optional, default 255)
 * @param        step betwenn to values (optional, default 5) 
 * @param        the orientation (none, vertical, semicircle)
 */
 {% macro slider(id, gad, min, max, step, orientation) %}
    /** Design */
    <input id="{{ page }}-{{ id }}" type="range" value="0" min="{{ min|default(0) }}" max="{{ max|default(255) }}" step="{{ step|default(5) }}" orientation="{{ orientation }}" data-highlight="true" />

    /** Events */
    <script type="text/javascript">
        knx.add({ 
            gad: '{{ gad }}',
            update: function(response){ 
                // jquery.mobile bugfix: change is triggert after refresh
                $('#{{ page }}-{{ id }}').unbind('change');
                $('#{{ page }}-{{ id }}').val(response).slider('refresh');
                
                var sval = $("#{{ page }}-{{ id }}").bind('change', function(event){
                if(sval != $(this).val() ){
                    sval = $(this).val(); 
                    if (sval == {{ min|default(0) }} || sval == {{ max|default(255) }})
                        knx.write('{{ gad }}', $('#{{ page }}-{{ id }}').val());  
                    }
                }).val();
            }
        });
        
        $('#{{ page }}').on('pageinit',function(){
            $("#{{ page }}-{{ id }}").on('stop', function(event) { 
                knx.write('{{ gad }}', $('#{{ page }}-{{ id }}').val());   
            }); 
        });
    </script>    
{% endmacro %}


/**
 * A symbol, with no writing to knx, only displayed when the value of gad is equal to val. Symbols may be used in menu-items.
 * If more than one gad is given, they will be combined with 'or' 
 * 
 * @param        unique id for this widget
 * @param        the knx gad(s)
 * @param        the text, printed when gad has value val 
 * @param        the pic, shown when gad has value val
 * @param        value (default 1) 
 */
 {% macro symbol(id, gads, txt, pic, val) %}
    /** Design */
    <span id="{{ page }}-{{ id }}" class="symbol hide"><img class="icon" src="{{ pic|default(icon1~'steuer_ein_aus.png') }}"/>{{ txt }}</span>
        
    /** Events */
    <script type="text/javascript">  
        knx.add({ 
            gad: {{ array2script(gads) }},
            update: function(response){ 
                // response will be an array, if more then one gad is used 
                var bit = false;
                if (response instanceof Array) {
                    for(var i = 0; i < response.length; i++) {
                        bit = bit || (response[i] == {{ val|default('1') }});
    		    }}
                else
                    bit = (response == {{ val|default('1') }});   
    		      
                if (bit)
                    $('#{{ page }}-{{ id }}').show();
                else
                    $('#{{ page }}-{{ id }}').hide();
            }
        });  
    </script>    
{% endmacro %} 


/**
 * A switch, build of two pics
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        the pic for the 'on' state
 * @param        the pic for the 'off' state
 * @param        value send for the 'on' state
 * @param        value send for the 'off' state 
 */
 {% macro switch(id, gad, pic_on, pic_off, val_on, val_off) %}
    /** Design */
    <span id="{{ page }}-{{ id }}" class="switch">
        <a><img class="icon" src="{{ pic_off|default(icon0~'steuer_ein_aus.png') }}"/></a>
    </span>
        
    /** Events */
    <script type="text/javascript"> 
        knx.add({ 
            gad: '{{ gad }}',
            update: function(response){ 
                $('#{{ page }}-{{ id }} .icon').attr('src', (response == {{ val_on|default('1') }} ? "{{ pic_on|default(icon1~'steuer_ein_aus.png') }}" : "{{ pic_off|default(icon0~'steuer_ein_aus.png') }}"));
            }
        });
             
        // write
        $('#{{ page }}-{{ id }} a').unbind('click').bind('click', function(){
            if ($('#{{ page }}-{{ id }} .icon').attr('src') == "{{ pic_off|default(icon0~'steuer_ein_aus.png') }}" ){
                knx.write('{{ gad }}', "{{ val_on|default('1') }}");
                knx.update('{{ gad }}', "{{ val_on|default('1') }}");
            } else {
                knx.write('{{ gad }}', "{{ val_off|default('0') }}");
                knx.update('{{ gad }}', "{{ val_off|default('0') }}");
            }
        });
        
        // effects
        $('#{{ page }}-{{ id }} .icon').hover(
            function() { $(this).addClass("ui-focus");  },  
            function() { $(this).removeClass("ui-focus"); }
        );
    </script>    
{% endmacro %} 


/**
 * A button
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        text printed on the button
 * @param        a icon or a inline pic (arrow-l, arrow-r, arrow-u, arrow-d, delete, plus, minus, check, gear, refresh, forward, back, grid, star, alert, info, home, search)
 * @param        value send if the button is pressed
 */
 {% macro button(id, gad, txt, pic, val) %}
    /** Design */
    <a id="{{ page }}-{{ id }}" data-theme="a" data-role="button" data-mini="true" data-inline="true"
        {% if pic|substr(-4, 4) == '.png' %}
            ><img class="icon" title="{{ txt|e }}" src="{{ pic }}">
        {% else %}
            {% if txt %} data-iconpos="top" {% else %} data-iconpos="notext" {% endif %}
            {% if pic %} data-icon="{{ pic }}" {% endif %}>{{ txt|e }}
        {% endif %}
        </a>
    
    {% if gad %}
        /** Events */
        <script type="text/javascript">
            $('#{{ page }}-{{ id }}').unbind('click').bind('click', function(){ 
                knx.write('{{ gad }}', {{ val|default('1') }}); 
            });
        </script>    
    {% endif %}
{% endmacro %}


/**
 * A switch with to states displayed as a button
 * 
 * @param        unique id for this widget
 * @param        a gad/item  
 * @param        the pic for the 'on' state
 * @param        the pic for the 'off' state
 */
 {% macro dual(id, gad, pic_on, pic_off) %}
    /** Design */
    <a id="{{ page }}-{{ id }}" data-role="button" data-inline="true">
        <img class="icon" src="{{ pic_off|default(icon0~'steuer_ein_aus.png') }}">
    </a> 
    
    /** Events */
    <script type="text/javascript"> 
        knx.add({ 
            gad: '{{ gad }}',
            update: function(response){ 
                $('#{{ page }}-{{ id }} img').attr('src', (response != 0 ? "{{ pic_on|default(icon1~'steuer_ein_aus.png') }}" : "{{ pic_off|default(icon0~'steuer_ein_aus.png') }}"));
            }
        });
        
        $('#{{ page }}-{{ id }}').unbind('click').bind('click', function(){
            if ($('#{{ page }}-{{ id }} img').attr('src') == "{{ pic_off|default(icon0~'steuer_ein_aus.png') }}" ){
                knx.write('{{ gad }}', '1');
                knx.update('{{ gad }}', '1');
            } else {
                knx.write('{{ gad }}', '0');
                knx.update('{{ gad }}', '0');
            }
        });
    </script>     
{% endmacro %}


/**
 * Displays a shutter-control
 * 
 * @param       unique id for this widget
 * @param       a gad/item for the actual position of the blinds
 * @param       a gad/item for the actual angle of the blinds (optional, readonly)
 * @param       the minimum value for close (optional, default 0)
 * @param       the maximum value for open (optional, default 255) 
 * @param       step betwenn to values (optional, default 5) 
 * @param       the mode: 'half' blade turns from -1 to +1), or 'full' blade turns form 0 to +1 (optional, default 'half')
 * 
 * @info        inspired by Jörg Gutowski     
 */
 {% macro shutter(id, gad_pos, gad_angle, min, max, step, mode) %}
    /** Design */
    <div id="{{ page }}-{{ id }}" class="shutter">
        {% for i in 1..12 %}
            <div class="blade-pos" id="{{ page }}-{{ id }}-{{ i }}"></div>
        {% endfor %}
    </div>
   

    /** Events */
    <script type="text/javascript">  
        knx.add({ 
            gad: Array('{{ gad_pos }}', '{{ gad_angle }}'),
            update: function(response){
                
                var a = 13;
                var mode = {% if mode|default('half') == 'half' %}0.5{% else %}1{% endif %};
                {% if gad_angle %}
                    a = parseInt(13 / mode * (response[1] / {{ max|default(255) }} + mode - 1));
                {% endif %} 
             
                var style;
                    
                h = parseInt(response[0] * 13 * 14 / {{ max|default(255) }});
                for (var i = 12; i >= 1; i--) {
                    if (h >= 14) {
                        var w = 13 - Math.abs(a);
                        style  = 'height: ' + ((h > i * 14) && a == 13 ? (14 - w) : (15 - w)) + 'px;';
                        
                        if (a != 13)
                            style += 'margin-top: ' + (h - 15 >= 14 ? w : parseInt(w / 2)) + 'px;';
                        else
                            style += 'border-top: 1px dotted ' + (h > i * 14 ? '#ccc' : '#333') + ';';
                       
                        if (a > 0)
                            $('#{{ page }}-{{ id }}-' + i).attr('class', 'blade-pos');
                        else
                            $('#{{ page }}-{{ id }}-' + i).attr('class', 'blade-neg');
                        
                        $('#{{ page }}-{{ id }}-' + i).attr('style', style);
                        h = h - 15;
                    }
                    else {
                        style  = 'height: ' + h + 'px;';
                        style += 'border-top: 1px dotted #aaa;';
                        $('#{{ page }}-{{ id }}-' + i).attr('style', style);
                        h = 1;
                    }
                }
            }
        });  
        
        $("#{{ page }}-{{ id }}").unbind('click').bind('click', function(event) { 
            var offset = $(this).offset();
            var x = (event.pageX - offset.left);
            var y = (event.pageY - offset.top);
            var val = Math.floor((y / 160 - 10 / 160) * {{ max|default(255) }} / {{ step|default(5) }}) * {{ step|default(5) }};
                val = Math.max({{ min|default(0) }}, Math.min(val, {{ max|default(255) }}));
                
	        knx.write('{{ gad_pos }}', val);
	        knx.update('{{ gad_pos }}', val);
        });
    </script>    
{% endmacro %} 


/**
 * Displays a rgb-selector
 * 
 * @param       unique id for this widget
 * @param       a gad/item for the r - value (0 - 255)
 * @param       a gad/item for the g - value (0 - 255)
 * @param       a gad/item for the b - value (0 - 255) 
 */
 {% macro rgb(id, gad_r, gad_g, gad_b) %}
    /** Design */
    <a id="{{ page }}-{{ id }}" class="rgb" href="#{{ page }}-{{ id }}-popup" data-rel="popup"><span></span></a>
    
    <div id="{{ page }}-{{ id }}-popup" class="rgb-popup" data-role="popup"></div>
    
    
    <script type="text/javascript"> 
        // design
        var html = '';
        
        for (var s = 25; s <= 75; s += 25) {
            for (var h = 0; h <= 288; h += 36) {
                html += '<div style="background-color:' + hsv2rgb(h, s, 100) + ';"></div>';      
            }
            html += '<div style="background-color:' + hsv2rgb(h, 0, 100 - (s / 25 - 1) *  14.2 ) + ';"></div><br />';      
        }
        for (var v = 100; v >= 25; v -= 25) {
            for (var h = 0; h <= 288; h += 36) {
                html += '<div style="background-color:' + hsv2rgb(h, 100, v) + ';"></div>';      
            }
            html += '<div style="background-color:' + hsv2rgb(h, 0, (v / 25) *  14.2) + ';"></div><br />';      
        }
        
        $("#{{ page }}-{{ id }}-popup").html(html);
        
        // knx
        knx.add({ 
            gad: Array('{{ gad_r }}', '{{ gad_g }}', '{{ gad_b }}'),
            update: function(response){
                $('#{{ page }}-{{ id }} span').css('background-color', 'rgb(' + response[0] + ',' + response[1] + ',' + response[2] + ')');  
            }
        });  
        
        // click
        $('#{{ page }}-{{ id }}-popup div').click(function() {
            var rgb = $(this).css('background-color');
            $('#{{ page }}-{{ id }} span').css('background-color', rgb);
            $('#{{ page }}-{{ id }}-popup').popup('close');  
            
            rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/); 
            knx.write('{{ gad_r }}', rgb[1]); knx.write('{{ gad_g }}', rgb[2]); knx.write('{{ gad_b }}', rgb[3]); 
        });
        
        // effects
        $('#{{ page }}-{{ id }}-popup div').hover(
            function() { $(this).addClass('ui-focus'); },  
            function() { $(this).removeClass('ui-focus'); }
        );
    </script> 
{% endmacro %} 


