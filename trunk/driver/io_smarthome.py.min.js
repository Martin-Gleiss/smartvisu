/* smartVISU, Martin Glei√ü, 2013, GPL [http://www.gnu.de] */
var io={adress:"",port:"",read:function(a){},write:function(a,c){io.send({cmd:"item",id:a,val:c});widget.update(a,c)},init:function(a,c){io.address=a;io.port=c;io.open()},run:function(a){widget.refresh();io.monitor()},version:2,socket:!1,open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.send({cmd:"proto",ver:io.version});io.monitor()};io.socket.onmessage=function(a){var c,b=JSON.parse(a.data);switch(b.cmd){case "item":for(var d=0;d<b.items.length;d++)a=
b.items[d][0],c=b.items[d][1],!1===c&&(c=0),!0===c&&(c=1),widget.update(a,c);break;case "series":b.sid=b.sid.substr(0,b.sid.length-3)+"0";widget.update(b.sid.replace(/\|/g,"."),b.series);break;case "dialog":notify.info(b.header,b.content);break;case "proto":a=parseInt(b.ver),a!=io.version&&notify.info("Driver: smarthome.py","Protocol mismatch<br />driver is: v"+io.version+"<br />smarthome.py is: v"+a)}};io.socket.onerror=function(a){notify.error("Driver: smarthome.py","Could not connect to smarthome.py server!<br /> Websocket error "+
a.data+".")};io.socket.onclose=function(){notify.debug("Driver: smarthome.py","Connection closed to smarthome.py server!")}},send:function(a){1==io.socket.readyState&&io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))))},monitor:function(){widget.listening()&&(io.send({cmd:"monitor",items:widget.listeners()}),widget.plot().each(function(a){a=widget.explode($(this).attr("data-item"));for(var c=0;c<a.length;c++)if(widget.is_series(a[c])&&!widget.get(a[c])){var b=a[c].split("."),d=a[c].substr(0,
a[c].length-3-b[b.length-3].length-b[b.length-2].length-b[b.length-1].length);io.send({cmd:"series",item:d,series:b[b.length-3],start:b[b.length-2]})}}))},close:function(){0<io.socket.readyState&&io.socket.close();io.socket=null}}; 
