/* smartVISU, Martin Glei√ü, 2012 - 2015, GPL [http://www.gnu.de] */
var io={address:"",port:"",read:function(a){},write:function(a,c){io.send({cmd:"item",id:a,val:c});widget.update(a,c)},trigger:function(a,c){io.send({cmd:"trigger",type:a,id:c})},init:function(a,c){io.address=a;io.port=c;io.open()},run:function(a){1<io.socket.readyState?io.open():(widget.refresh(),io.monitor())},version:"0.4",socket:!1,open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.send({cmd:"proto",ver:io.version});io.monitor()};io.socket.onmessage=
function(a){var c,d;a=JSON.parse(a.data);switch(a.cmd){case "item":for(var b=0;b<a.items.length;b+=2)c=a.items[b],d=a.items[b+1],widget.update(c,d);break;case "series":widget.update(a.items.id,a.items.plotdata);break;case "dialog":notify.info(a.header,a.content);break;case "log":c=widget.get(a.name);for(b=0;b<a.log.length;b++)c.unshift(a.log[b]),50<=c.length&&c.pop();widget.update(a.name);break;case "proto":a=a.ver,a!=io.version&&notify.info("Driver: DomotiGa","Protocol version mismatch<br />Driver is at version v"+
io.version+"<br />DomotiGa is at version v"+a)}};io.socket.onerror=function(a){notify.error("Driver: DomotiGa","Could not connect to the DomotiGa server!<bre >?Websocket error: "+a.data+".")};io.socket.onclose=function(){notify.error("Driver: DomotiGa","No connection with the DomotiGa server!")}},send:function(a){1==io.socket.readyState&&io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))))},monitor:function(){widget.listeners().length&&io.send({cmd:"monitor",items:widget.listeners()});
var a=[];widget.plot().each(function(c){c=widget.explode($(this).attr("data-item"));for(var d=0;d<c.length;d++){var b=c[d].split(".");if(!a[c[d]]&&!widget.get(c[d])&&b instanceof Array&&widget.checkseries(c[d])){var e=c[d].substr(0,c[d].length-4-b[b.length-4].length-b[b.length-3].length-b[b.length-2].length-b[b.length-1].length);io.send({cmd:"series",item:e,mode:b[b.length-4],tmin:b[b.length-3],tmax:b[b.length-2],count:b[b.length-1]});a[c[d]]=1}}});widget.log().each(function(a){io.send({cmd:"log",
name:$(this).attr("data-item"),max:$(this).attr("data-count")})})},close:function(){0<io.socket.readyState&&io.socket.close();io.socket=null}}; 
