/* smartVISU, Martin Glei√ü, 2013, GPL [http://www.gnu.de] */
var io={adress:"",port:"",read:function(a){io.get(a)},write:function(a,b){io.put(a,b)},trigger:function(a,b){},init:function(a,b){io.address=a;io.port=b;io.stop()},run:function(a){widget.refresh();io.all();a&&io.start()},timer:0,timer_run:!1,loop:function(){widget.listening()&&(io.timer=setTimeout("io.loop(); io.all();",1E3))},start:function(){!io.timer_run&&widget.listening()&&(io.loop(),io.timer_run=!0)},stop:function(){clearTimeout(io.timer);io.timer_run=!1},get:function(a){$.ajax({url:"driver/io_offline.php",
data:{item:a},type:"GET",dataType:"json",async:!0,cache:!1}).done(function(b){widget.update(a,b[a])})},put:function(a,b){var c=io.timer_run;io.stop();$.ajax({url:"driver/io_offline.php",data:{item:a,val:b},type:"GET",dataType:"json",cache:!1}).done(function(b){widget.update(a,b[a]);c&&io.start()})},all:function(){var a="";if(widget.listening()){for(var b=widget.listeners(),c=0;c<widget.listeners().length;c++)a+=b[c]+",";a=a.substr(0,a.length-1);$.ajax({url:"driver/io_offline.php",data:{item:a},type:"POST",
dataType:"json",async:!0,cache:!1}).done(function(a){widget.plot().each(function(b){b=widget.explode($(this).attr("data-item"));for(var c=0;c<b.length;c++){var d=b[c].split(".");null==a[b[c]]&&null==widget.get(b[c])&&widget.is_series(b[c])&&(a[b[c]]=io.demoseries(d[d.length-2],d[d.length-1],$(this).attr("data-ymin"),$(this).attr("data-ymax"),$(this).attr("data-step")))}});widget.log().each(function(a){widget.set($(this).attr("data-item"),io.demolog($(this).attr("data-count")))});$.each(a,function(a,
b){widget.update(a,b)})})}},demoseries:function(a,b,c,f,e){var g=[];c||(c=0);f||(f=255);var d=1*c+(f-c)/2;c=(f-c)/20;a=(new Date).getTime()-(new Date).duration(a);b=(new Date).getTime()-(new Date).duration(b);for(e=Math.round((b-a)/e);a<=b;)d+=2*Math.random()*c-c,g.push([a,1*d.toFixed(2)]),a+=e;return g},demolog:function(a){for(var b=[],c=["info","warning","error"],f=["The heating ist to hot!","The heating ist to hot! Please switch it off!","The heating ist to hot! It will burn now!"],e=(new Date).getTime()-
(new Date).duration(a+"i"),g=(new Date).getTime(),d=Math.round((g-e)/a);e<g;)a=Math.floor(3*Math.random()),b.push({time:Math.floor(e+Math.random()*d*0.2-0.1*d),level:c[a],message:f[a]}),e+=d;return b}}; 
