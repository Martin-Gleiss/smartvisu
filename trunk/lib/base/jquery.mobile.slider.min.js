/* smartVISU, Martin Glei√ü, 2013, GPL [http://www.gnu.de] */
(function(a,w){a.widget("mobile.slider",a.mobile.widget,{widgetEventPrefix:"slide",options:{theme:null,trackTheme:null,disabled:!1,initSelector:"input[type='range'], :jqmData(type='range'), :jqmData(role='slider')",mini:!1,highlight:!1},_create:function(){var d=this.element,r=a.mobile.getInheritedTheme(d,"c"),l=this.options.theme||r,r=this.options.trackTheme||r,t=d[0].nodeName.toLowerCase();this.isToggleSwitch="select"===t;var g=d.parent().is(":jqmData(role='rangeslider')"),e=this.isToggleSwitch?
"ui-slider-switch":"",f=d.attr("id"),h=a("[for='"+f+"']"),b=h.attr("id")||f+"-label",h=h.attr("id",b),s=this.isToggleSwitch?0:parseFloat(d.attr("min")),n=this.isToggleSwitch?d.find("option").length-1:parseFloat(d.attr("max")),p=d.attr("orientation"),u=window.parseFloat(d.attr("step")||1),c=this.options.mini||d.jqmData("mini")?" ui-mini":"",k=document.createElement("a"),f=a(k),m=document.createElement("div"),q=a(m),v=this.options.highlight&&!this.isToggleSwitch?function(){var b=document.createElement("div");
if("semicircle"==p){b.className="ui-slider-bg";var c=document.createElement("div");c.className="ui-slider-track-semicircle "+a.mobile.activeBtnClass;b.appendChild(c)}else b.className="ui-slider-bg "+a.mobile.activeBtnClass+" ui-btn-corner-all";return a(b).prependTo(q)}():!1;k.setAttribute("href","#");m.setAttribute("role","application");m.className=[(this.isToggleSwitch?"ui-slider":"ui-slider-track")+(p?"-"+p:" "),e," ui-btn-down-",r," ui-btn-corner-all",c].join("");k.className="ui-slider-handle"+
(p?"-"+p:"");m.appendChild(k);"semicircle"==p&&(e=document.createElement("div"),e.className="ui-slider-semicircle-box",c=document.createElement("div"),c.className="ui-slider-semicircle-cut",e.appendChild(c),c.appendChild(m),k=document.createElement("div"),k.className="ui-slider-semicircle-inner ui-body-"+r,c.appendChild(k),c=document.createElement("div"),c.className="ui-slider-semicircle-bottom "+(v?a.mobile.activeBtnClass:"")+" ui-btn-down-"+r,c.style.cssFloat="left",e.appendChild(c),c=document.createElement("div"),
c.className="ui-slider-semicircle-bottom ui-btn-down-"+r,c.style.cssFloat="right",e.appendChild(c),q=a(e));f.buttonMarkup({corners:!0,theme:l,shadow:!0}).attr({role:"slider","aria-valuemin":s,"aria-valuemax":n,"aria-valuenow":this._value(),"aria-valuetext":this._value(),title:this._value(),"aria-labelledby":b});a.extend(this,{slider:q,handle:f,type:t,step:u,max:n,min:s,valuebg:v,isRangeslider:g,dragging:!1,beforeStart:null,userModified:!1,mouseMoved:!1});if(this.isToggleSwitch){l=document.createElement("div");
l.className="ui-slider-inneroffset";t=0;for(b=m.childNodes.length;t<b;t++)l.appendChild(m.childNodes[t]);m.appendChild(l);f.addClass("ui-slider-handle-snapping");l=d.find("option");f=0;for(m=l.length;f<m;f++)t=f?"a":"b",b=f?" "+a.mobile.activeBtnClass:" ui-btn-down-"+r,document.createElement("div"),s=document.createElement("span"),s.className=["ui-slider-label ui-slider-label-",t,b," ui-btn-corner-all"].join(""),s.setAttribute("role","img"),s.appendChild(document.createTextNode(l[f].innerHTML)),a(s).prependTo(q);
this._labels=a(".ui-slider-label",q)}h.addClass("ui-slider");d.addClass(this.isToggleSwitch?"ui-slider-switch":"ui-slider-input");this._on(d,{change:"_controlChange",keyup:"_controlKeyup",blur:"_controlBlur",vmouseup:"_controlVMouseUp"});q.bind("vmousedown",a.proxy(this._sliderVMouseDown,this)).bind("vclick",!1);this._on(document,{vmousemove:"_preventDocumentDrag"});this._on(q.add(document),{vmouseup:"_sliderVMouseUp"});q.insertAfter(d);this.isToggleSwitch||g||(l=this.options.mini?"<div class='ui-slider ui-mini'>":
"<div class='ui-slider'>",d.add(q).wrapAll(l));this.isToggleSwitch&&this.handle.bind({focus:function(){q.addClass(a.mobile.focusClass)},blur:function(){q.removeClass(a.mobile.focusClass)}});this._on(this.handle,{vmousedown:"_handleVMouseDown",keydown:"_handleKeydown",keyup:"_handleKeyup"});this.handle.bind("vclick",!1);this._handleFormReset&&this._handleFormReset();this.refresh(w,w,!0)},_controlChange:function(a){if(!1===this._trigger("controlchange",a))return!1;this.mouseMoved||this.refresh(this._value(),
!0)},_controlKeyup:function(a){this.refresh(this._value(),!0,!0)},_controlBlur:function(a){this.refresh(this._value(),!0)},_controlVMouseUp:function(a){this._checkedRefresh()},_handleVMouseDown:function(a){this.handle.focus()},_handleKeydown:function(d){var r=this._value();if(!this.options.disabled){switch(d.keyCode){case a.mobile.keyCode.HOME:case a.mobile.keyCode.END:case a.mobile.keyCode.PAGE_UP:case a.mobile.keyCode.PAGE_DOWN:case a.mobile.keyCode.UP:case a.mobile.keyCode.RIGHT:case a.mobile.keyCode.DOWN:case a.mobile.keyCode.LEFT:d.preventDefault(),
this._keySliding||(this._keySliding=!0,this.handle.addClass("ui-state-active"))}switch(d.keyCode){case a.mobile.keyCode.HOME:this.refresh(this.min);break;case a.mobile.keyCode.END:this.refresh(this.max);break;case a.mobile.keyCode.PAGE_UP:case a.mobile.keyCode.UP:case a.mobile.keyCode.RIGHT:this.refresh(r+this.step);break;case a.mobile.keyCode.PAGE_DOWN:case a.mobile.keyCode.DOWN:case a.mobile.keyCode.LEFT:this.refresh(r-this.step)}}},_handleKeyup:function(a){this._keySliding&&(this._keySliding=!1,
this.handle.removeClass("ui-state-active"))},_sliderVMouseDown:function(a){if(this.options.disabled||!1===this._trigger("beforestart",a))return!1;this.dragging=!0;this.mouseMoved=this.userModified=!1;this.isToggleSwitch&&(this.beforeStart=this.element[0].selectedIndex);this.refresh(a);this._trigger("start");return!1},_sliderVMouseUp:function(){if(this.dragging)return this.dragging=!1,this.isToggleSwitch&&(this.handle.addClass("ui-slider-handle-snapping"),this.mouseMoved?this.userModified?this.refresh(0===
this.beforeStart?1:0):this.refresh(this.beforeStart):this.refresh(0===this.beforeStart?1:0)),this.mouseMoved=!1,this._trigger("stop"),!1},_preventDocumentDrag:function(a){if(!1===this._trigger("drag",a))return!1;if(this.dragging&&!this.options.disabled)return this.mouseMoved=!0,this.isToggleSwitch&&this.handle.removeClass("ui-slider-handle-snapping"),this.refresh(a),this.userModified=this.beforeStart!==this.element[0].selectedIndex,!1},_checkedRefresh:function(){this.value!=this._value()&&this.refresh(this._value())},
_value:function(){return this.isToggleSwitch?this.element[0].selectedIndex:parseFloat(this.element.val())},_reset:function(){this.refresh(w,!1,!0)},refresh:function(d,r,l){var t=this,g=a.mobile.getInheritedTheme(this.element,"c"),e=this.options.theme||g,g=this.options.trackTheme||g,f=this.element.attr("orientation");t.slider[0].className="semicircle"==f?"ui-slider-semicircle-box":[this.isToggleSwitch?"ui-slider ui-slider-switch":"ui-slider-track"+(f?"-"+f:" ")," ui-btn-down-"+g," ui-btn-corner-all",
this.options.mini?" ui-mini":""].join("");(this.options.disabled||this.element.attr("disabled"))&&this.disable();this.value=this._value();this.options.highlight&&(!this.isToggleSwitch&&0===this.slider.find(".ui-slider-bg").length)&&(this.valuebg=function(){var b=document.createElement("div");b.className="ui-slider-bg "+a.mobile.activeBtnClass+" ui-btn-corner-all";return a(b).prependTo(t.slider)}());this.handle.buttonMarkup({corners:!0,theme:e,shadow:!0});var h,b,e=this.element,s=(g=!this.isToggleSwitch)?
[]:e.find("option"),n=g?parseFloat(e.attr("min")):0,p=g?parseFloat(e.attr("max")):s.length-1,u=g&&0<parseFloat(e.attr("step"))?parseFloat(e.attr("step")):1,f=e.attr("orientation");if("object"===typeof d){var c,k;b=d;c=this.slider.offset().left;k=this.slider.width();h=k/((p-n)/u);if(!this.dragging||b.pageX<c-8||b.pageX>c+k+8)return;"vertical"==f?b=Math.round(100*((b.pageY-this.slider.offset().top)/this.slider.height())):"bottomup"==f?b=100-Math.round(100*((b.pageY-this.slider.offset().top)/this.slider.height())):
"semicircle"==f?(c=b.pageX-this.slider.offset().left-this.slider.width()/2-2,b=-(b.pageY-this.slider.offset().top-this.slider.height()+8),b=Math.round(100*((180*(Math.atan2(c,b)/Math.PI)+90)/180)),0>b&&(b=0),100<b&&(b=100)):b=1<h?100*((b.pageX-c)/k):Math.round(100*((b.pageX-c)/k))}else null==d&&(d=g?parseFloat(e.val()||0):e[0].selectedIndex),b=100*((parseFloat(d)-n)/(p-n));if(!isNaN(b)){c=b/100*(p-n)+n;var m=(c-n)%u;c-=m;2*Math.abs(m)>=u&&(c+=0<m?u:-u);m=100/((p-n)/u);c=parseFloat(c.toFixed(5));"undefined"===
typeof h&&(h=k/((p-n)/u));1<h&&g&&(b=(c-n)*m*(1/u));0>b&&(b=0);100<b&&(b=100);c<n&&(c=n);c>p&&(c=p);"vertical"==f?(this.handle.css("top",b+"%"),this.valuebg&&this.valuebg.css("height",b+"%")):"bottomup"==f?(this.handle.css("top",100-b+"%"),this.valuebg&&this.valuebg.css("margin-top",(this.slider.height()*(100-b)/100).toFixed(0)+"px"),this.valuebg&&this.valuebg.css("height",b+"%")):"semicircle"==f?(h=(180*(b/100)-90)/180*Math.PI,this.handle.css("top",Math.round(-Math.cos(h)*(this.slider.width()/2-
8)+((0==this.slider.height()?92:this.slider.height())-4))+"px"),this.handle.css("left",Math.round(Math.sin(h)*(this.slider.width()/2-8)+(this.slider.width()/2+4))+"px"),k=(1.08*b-8).toFixed(0),this.valuebg&&this.valuebg.css("width",(1>k?1:k)+"%")):(this.handle.css("left",b+"%"),this.valuebg&&this.valuebg.css("width",b+"%"));this.handle[0].setAttribute("aria-valuenow",g?c:s.eq(c).attr("value"));this.handle[0].setAttribute("aria-valuetext",g?c:s.eq(c).getEncodedText());this.handle[0].setAttribute("title",
g?c:s.eq(c).getEncodedText());if(this._labels){h=100*(this.handle.width()/this.slider.width());var q=b&&h+(100-h)*b/100,v=100===b?0:Math.min(h+100-q,100);this._labels.each(function(){var b=a(this).is(".ui-slider-label-a");a(this).width((b?q:v)+"%")})}if(!l){l=!1;g?(l=e.val()!==c,e.val(c)):(l=e[0].selectedIndex!==c,e[0].selectedIndex=c);if(!1===this._trigger("beforechange",d))return!1;!r&&l&&e.trigger("change")}}},enable:function(){this.element.attr("disabled",!1);this.slider.removeClass("ui-disabled").attr("aria-disabled",
!1);return this._setOption("disabled",!1)},disable:function(){this.element.attr("disabled",!0);this.slider.addClass("ui-disabled").attr("aria-disabled",!0);return this._setOption("disabled",!0)}});a.widget("mobile.slider",a.mobile.slider,a.mobile.behaviors.formReset);a.mobile.document.bind("pagecreate create",function(d){a.mobile.slider.prototype.enhanceWithin(d.target,!0)})})(jQuery); 
